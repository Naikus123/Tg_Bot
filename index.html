<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>–ú–æ–π –ü–æ–º–æ—â–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º */
        :root {
            --bg: #1c1c1e;
            --surface: #2c2c2e;
            --text: #ffffff;
            --hint: #98989d;
            --accent: #34c759;
            --danger: #ff3b30;
        }
        [data-theme="neon"] { --bg: #0d0221; --surface: #261447; --accent: #f72585; --text: #fff; }
        [data-theme="hacker"] { --bg: #0a0a0a; --surface: #111; --accent: #00ff00; --text: #00ff00; --hint: #008800; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; overflow-x: hidden; transition: background 0.3s; }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω (–ó–≤–µ–∑–¥—ã) */
        #starfield { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; pointer-events: none; }

        /* Splash Screen (–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω) */
        #splash {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg); display: flex; justify-content: center; align-items: center;
            z-index: 9999; font-size: 40px; font-weight: 900; letter-spacing: 5px; color: var(--accent);
            text-shadow: 0 0 20px var(--accent); animation: splashFade 2.5s forwards;
        }
        @keyframes splashFade { 0% { opacity: 1; transform: scale(0.8); } 70% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; visibility: hidden; } }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        .header { padding: 20px; font-size: 28px; font-weight: bold; position: sticky; top: 0; z-index: 10; background: rgba(var(--bg), 0.9); backdrop-filter: blur(10px); }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background-color: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; cursor: pointer;
            border: 1px solid transparent;
        }
        .card:active { transform: scale(0.96); }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
        .card-text { font-size: 14px; color: var(--hint); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-height: 20px; }
        .card-meta { font-size: 12px; color: var(--accent); margin-top: 10px; font-weight: 500; display: flex; justify-content: space-between;}
        .countdown { color: var(--accent); font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ (FAB) */
        .fab {
            position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 28px;
            background-color: var(--accent); color: #fff; border: none; font-size: 28px;
            box-shadow: 0 0 15px var(--accent); cursor: pointer; z-index: 100; transition: 0.2s;
        }
        .fab:active { transform: scale(0.8) rotate(45deg); }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background-color: var(--surface);
            display: flex; justify-content: space-around; padding: 10px 0 20px 0; z-index: 100;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--hint); font-size: 12px; width: 25%; transition: 0.2s; }
        .nav-item.active { color: var(--accent); transform: translateY(-3px); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–†–µ–¥–∞–∫—Ç–æ—Ä / –ü—Ä–æ—Å–º–æ—Ç—Ä) */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; flex-direction: column; justify-content: flex-end;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.open { display: flex; opacity: 1; }
        .modal-content {
            background-color: var(--bg); width: 100%; height: 90vh; border-radius: 20px 20px 0 0;
            padding: 20px; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .modal.open .modal-content { transform: translateY(0); }
        
        .input-field, select {
            width: 100%; background-color: var(--surface); color: var(--text); border: 1px solid var(--hint);
            border-radius: 12px; padding: 15px; margin-bottom: 15px; font-size: 16px; outline: none; transition: 0.2s;
        }
        .input-field:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(var(--accent), 0.3); }
        textarea.input-field { flex-grow: 1; resize: none; }

        .btn-row { display: flex; gap: 10px; margin-top: auto; }
        .btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; color: #fff; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-save { background-color: var(--accent); }
        .btn-cancel { background-color: var(--surface); color: var(--text); }
        .btn-delete { background-color: var(--danger); flex: 0.3; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .theme-btn { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: none; font-weight: bold; background: var(--surface); color: var(--text); cursor: pointer; }
    </style>
</head>
<body>

    <div id="splash">An1mk0</div>
    <canvas id="starfield"></canvas>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div id="tab-notes" class="tab-content active"><div class="header">üìù –ó–∞–º–µ—Ç–∫–∏</div><div id="notes-list"></div></div>
    <div id="tab-todos" class="tab-content"><div class="header">üìã –°–ø–∏—Å–æ–∫ –¥–µ–ª</div><div id="todos-list"></div></div>
    <div id="tab-reminders" class="tab-content"><div class="header">‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div><div id="reminders-list"></div></div>
    
    <div id="tab-settings" class="tab-content">
        <div class="header">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">–¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
            <button class="theme-btn" onclick="setTheme('default')" style="border-left: 5px solid #34c759;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (–¢—ë–º–Ω–∞—è)</button>
            <button class="theme-btn" onclick="setTheme('neon')" style="border-left: 5px solid #f72585;">–ù–µ–æ–Ω–æ–≤—ã–π –ö–∏–±–µ—Ä–ø–∞–Ω–∫</button>
            <button class="theme-btn" onclick="setTheme('hacker')" style="border-left: 5px solid #00ff00;">–•–∞–∫–µ—Ä—Å–∫–∞—è</button>
            <p style="color: var(--hint); font-size: 12px; margin-top: 20px;">–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ–±–ª–∞–∫–æ Telegram.</p>
        </div>
    </div>

    <button class="fab" onclick="openEditor()">+</button>

    <!-- –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω (–ß—Ç–µ–Ω–∏–µ / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
            <input type="text" id="edit-title" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
            <textarea id="edit-desc" class="input-field" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
            
            <div id="reminder-options" style="display: none;">
                <label style="color: var(--hint); font-size: 12px;">–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è:</label>
                <input type="datetime-local" step="1" id="edit-time" class="input-field">
                
                <label style="color: var(--hint); font-size: 12px;">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∑–∞–º–µ—Ç–∫—É/–∑–∞–¥–∞—á—É:</label>
                <select id="edit-attach" class="input-field">
                    <option value="">-- –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ --</option>
                </select>
            </div>

            <div class="btn-row">
                <button class="btn btn-delete" id="btn-delete" onclick="deleteItem()">üóë</button>
                <button class="btn btn-cancel" onclick="closeEditor()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-save" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('notes', this)"><span class="nav-icon">üìù</span><span>–ó–∞–º–µ—Ç–∫–∏</span></div>
        <div class="nav-item" onclick="switchTab('todos', this)"><span class="nav-icon">üìã</span><span>–ó–∞–¥–∞—á–∏</span></div>
        <div class="nav-item" onclick="switchTab('reminders', this)"><span class="nav-icon">‚è∞</span><span>–¢–∞–π–º–µ—Ä—ã</span></div>
        <div class="nav-item" onclick="switchTab('settings', this)"><span class="nav-icon">‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let currentTab = 'notes';
        let editingId = null; // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –∑–∞–ø–∏—Å–∏ (null –µ—Å–ª–∏ –Ω–æ–≤–∞—è)

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
        let appData = { notes: [], todos: [], reminders: [] };

        // --- –û–ë–õ–ê–ß–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø TELEGRAM ---
        function loadData() {
            tg.CloudStorage.getItem('an1mk0_data', (err, val) => {
                if (!err && val) {
                    appData = JSON.parse(val);
                }
                renderList();
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—É
            tg.CloudStorage.getItem('an1mk0_theme', (err, val) => {
                if (!err && val) setTheme(val);
            });
        }

        function saveDataToCloud() {
            tg.CloudStorage.setItem('an1mk0_data', JSON.stringify(appData));
        }

        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            tg.CloudStorage.setItem('an1mk0_theme', themeName);
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            el.classList.add('active');
            
            document.querySelector('.fab').style.display = tab === 'settings' ? 'none' : 'flex';
            renderList();
        }

        // --- –†–ï–î–ê–ö–¢–û–† (–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ò–∑–º–µ–Ω–µ–Ω–∏–µ) ---
        function openEditor(id = null) {
            editingId = id;
            const modal = document.getElementById('editor-modal');
            const titleEl = document.getElementById('edit-title');
            const descEl = document.getElementById('edit-desc');
            const timeEl = document.getElementById('edit-time');
            const attachEl = document.getElementById('edit-attach');
            const remOpts = document.getElementById('reminder-options');
            const btnDel = document.getElementById('btn-delete');

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—è–∑–æ–∫
            attachEl.innerHTML = '<option value="">-- –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ --</option>';
            appData.notes.concat(appData.todos).forEach(item => {
                attachEl.innerHTML += `<option value="${item.title}">[${item.type === 'note' ? '–ó–∞–º–µ—Ç–∫–∞' : '–ó–∞–¥–∞—á–∞'}] ${item.title}</option>`;
            });

            if (currentTab === 'reminders') {
                remOpts.style.display = 'block';
                descEl.style.display = 'none';
            } else {
                remOpts.style.display = 'none';
                descEl.style.display = 'block';
            }

            if (id !== null) {
                // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const item = appData[currentTab].find(i => i.id === id);
                titleEl.value = item.title;
                if (currentTab === 'reminders') {
                    timeEl.value = item.time_str;
                    attachEl.value = item.attached || "";
                } else {
                    descEl.value = item.desc;
                }
                btnDel.style.display = 'block';
            } else {
                // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è
                titleEl.value = ''; descEl.value = ''; timeEl.value = ''; attachEl.value = '';
                btnDel.style.display = 'none';
            }

            modal.classList.add('open');
        }

        function closeEditor() {
            document.getElementById('editor-modal').classList.remove('open');
        }

        // --- –°–û–•–†–ê–ù–ï–ù–ò–ï ---
        function saveItem() {
            const title = document.getElementById('edit-title').value.trim();
            if (!title) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

            const newItem = {
                id: editingId !== null ? editingId : Date.now(),
                type: currentTab === 'todos' ? 'todo' : currentTab === 'reminders' ? 'reminder' : 'note',
                title: title,
                date: new Date().toLocaleDateString()
            };

            if (currentTab === 'reminders') {
                const timeStr = document.getElementById('edit-time').value;
                if(!timeStr) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!");
                newItem.time_str = timeStr;
                newItem.timestamp = new Date(timeStr).getTime() / 1000; // Unix time –¥–ª—è Lua
                newItem.attached = document.getElementById('edit-attach').value;
            } else {
                newItem.desc = document.getElementById('edit-desc').value.trim();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤
            if (editingId !== null) {
                const idx = appData[currentTab].findIndex(i => i.id === editingId);
                appData[currentTab][idx] = newItem;
            } else {
                appData[currentTab].push(newItem);
            }

            saveDataToCloud();
            closeEditor();
            renderList();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ Lua-–±–æ—Ç—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
            let luaAction = 'save_' + newItem.type;
            tg.sendData(JSON.stringify({
                action: luaAction,
                title: newItem.title,
                desc: newItem.desc || "",
                timestamp: newItem.timestamp || 0,
                attached: newItem.attached || ""
            }));
        }

        // --- –£–î–ê–õ–ï–ù–ò–ï ---
        function deleteItem() {
            if(confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?")) {
                appData[currentTab] = appData[currentTab].filter(i => i.id !== editingId);
                saveDataToCloud();
                closeEditor();
                renderList();
            }
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–û–í ---
        function renderList() {
            const container = document.getElementById(currentTab + '-list');
            const items = appData[currentTab];
            
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:var(--hint); margin-top:50px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>`;
                return;
            }

            items.slice().reverse().forEach(item => {
                let extraHtml = '';
                if (currentTab === 'reminders') {
                    extraHtml = `
                        <div class="card-meta">
                            <span>–°—Ä–∞–±–æ—Ç–∞–µ—Ç: ${item.time_str.replace('T', ' ')}</span>
                            <span class="countdown" id="cd-${item.id}">–°—á–∏—Ç–∞–µ–º...</span>
                        </div>
                        ${item.attached ? `<div style="font-size:11px; color:var(--hint); margin-top:5px;">üîó –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ: ${item.attached}</div>` : ''}
                    `;
                } else {
                    extraHtml = `<div class="card-text">${item.desc}</div><div class="card-meta">–ò–∑–º–µ–Ω–µ–Ω–æ: ${item.date}</div>`;
                }

                container.innerHTML += `
                    <div class="card" onclick="openEditor(${item.id})">
                        <div class="card-title">${item.title}</div>
                        ${extraHtml}
                    </div>
                `;
            });
        }

        // --- –¢–ê–ô–ú–ï–†–´ –û–ë–†–ê–¢–ù–û–ì–û –û–¢–°–ß–ï–¢–ê ---
        setInterval(() => {
            if (currentTab !== 'reminders') return;
            const now = Math.floor(Date.now() / 1000);
            appData.reminders.forEach(item => {
                const el = document.getElementById('cd-' + item.id);
                if (el) {
                    const diff = item.timestamp - now;
                    if (diff <= 0) el.innerText = "‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!";
                    else {
                        const d = Math.floor(diff / 86400);
                        const h = Math.floor((diff % 86400) / 3600);
                        const m = Math.floor((diff % 3600) / 60);
                        const s = diff % 60;
                        el.innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${d}–¥ ${h}—á ${m}–º ${s}—Å`;
                    }
                }
            });
        }, 1000);

        // --- –ö–†–ê–°–ò–í–´–ô –§–û–ù –°–û –ó–í–ï–ó–î–ê–ú–ò (Canvas Animation) ---
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let stars = [];
        for(let i=0; i<50; i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, size: Math.random()*2, speed: Math.random()*1+0.5 });
        function animateStars() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
            stars.forEach(s => {
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
                s.y += s.speed;
                if(s.y > canvas.height) { s.y = 0; s.x = Math.random()*canvas.width; }
            });
            requestAnimationFrame(animateStars);
        }
        animateStars();

        // –ó–∞–ø—É—Å–∫
        loadData();
    </script>
</body>
</html>
