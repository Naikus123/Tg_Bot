<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>An1mk0 Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080c14;
            --surface: #0f1623;
            --surface2: #161f30;
            --text: #e8f0fe;
            --hint: #5c7080;
            --accent: #00d4ff;
            --accent2: #7c3aed;
            --glow: rgba(0, 212, 255, 0.4);
            --danger: #ff4757;
            --border: rgba(0, 212, 255, 0.15);
        }
        [data-theme="neon"] {
            --bg: #0a0015;
            --surface: #12002a;
            --surface2: #1a003d;
            --accent: #f72585;
            --accent2: #7209b7;
            --glow: rgba(247, 37, 133, 0.4);
            --border: rgba(247, 37, 133, 0.2);
            --text: #fce4ff;
        }
        [data-theme="hacker"] {
            --bg: #010a01;
            --surface: #021402;
            --surface2: #031f03;
            --accent: #00ff41;
            --accent2: #008f11;
            --glow: rgba(0, 255, 65, 0.35);
            --border: rgba(0, 255, 65, 0.15);
            --text: #ccffcc;
            --hint: #3d7a3d;
        }
        [data-theme="solar"] {
            --bg: #0c0800;
            --surface: #1a1000;
            --surface2: #251800;
            --accent: #ff9500;
            --accent2: #ff3b00;
            --glow: rgba(255, 149, 0, 0.4);
            --border: rgba(255, 149, 0, 0.2);
            --text: #fff8ec;
            --hint: #7a5c20;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            padding-bottom: 85px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ===== STARFIELD ===== */
        #starfield {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0; pointer-events: none;
        }

        /* ===== SPLASH ===== */
        #splash {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
            animation: splashExit 0.5s 2.2s forwards;
        }
        .splash-text {
            font-family: 'Orbitron', monospace;
            font-size: 36px; font-weight: 900;
            letter-spacing: 8px;
            color: var(--accent);
            text-shadow: 0 0 20px var(--accent), 0 0 60px var(--accent), 0 0 120px var(--accent);
            animation: splashGlow 0.4s ease-in-out infinite alternate;
        }
        .splash-sub {
            font-family: 'Exo 2', sans-serif;
            font-size: 11px; letter-spacing: 6px;
            color: var(--hint); margin-top: 10px;
            text-transform: uppercase;
            animation: fadeInUp 0.6s 0.4s both;
        }
        @keyframes splashGlow {
            from { text-shadow: 0 0 10px var(--accent), 0 0 40px var(--accent); }
            to   { text-shadow: 0 0 25px var(--accent), 0 0 80px var(--accent), 0 0 150px var(--accent); }
        }
        @keyframes splashExit {
            to { opacity: 0; pointer-events: none; visibility: hidden; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== LAYOUT ===== */
        .page { position: relative; z-index: 1; }

        .header {
            padding: 22px 20px 14px;
            font-family: 'Orbitron', monospace;
            font-size: 20px; font-weight: 700;
            letter-spacing: 2px;
            position: sticky; top: 0; z-index: 10;
            background: linear-gradient(to bottom, var(--bg) 70%, transparent);
            backdrop-filter: blur(12px);
            display: flex; align-items: center; gap: 12px;
            color: var(--accent);
            text-shadow: 0 0 12px var(--glow);
            border-bottom: 1px solid var(--border);
        }
        .header svg { filter: drop-shadow(0 0 6px var(--accent)); }

        /* ===== TABS ===== */
        .tab-content { display: none; padding: 16px; animation: fadeSlide 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== CARDS ===== */
        .card {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px 18px;
            margin-bottom: 12px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .card::before {
            content: '';
            position: absolute; top: 0; left: -100%;
            width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
            transition: left 0.4s;
        }
        .card:hover::before { left: 150%; }
        .card:active { transform: scale(0.97); box-shadow: 0 0 20px var(--glow); border-color: var(--accent); }

        .card-accent-line {
            position: absolute; left: 0; top: 0; bottom: 0;
            width: 3px; background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            border-radius: 3px 0 0 3px;
        }
        .card-inner { padding-left: 12px; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; letter-spacing: 0.5px; }
        .card-text {
            font-size: 13px; color: var(--hint);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.4;
        }
        .card-meta {
            font-size: 11px; color: var(--accent);
            margin-top: 10px; display: flex;
            justify-content: space-between; align-items: center;
            opacity: 0.8; letter-spacing: 0.5px;
        }
        .countdown {
            font-family: 'Orbitron', monospace;
            font-size: 10px; color: var(--accent);
            text-shadow: 0 0 8px var(--glow);
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ===== FAB ===== */
        .fab {
            position: fixed; bottom: 98px; right: 20px;
            width: 54px; height: 54px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff; border: none; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px var(--glow), 0 0 40px var(--glow);
            cursor: pointer; z-index: 100;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fab:active { transform: scale(0.85) rotate(45deg); box-shadow: 0 0 40px var(--glow); }

        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(8, 12, 20, 0.95);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 10px 0 18px;
            border-top: 1px solid var(--border);
            z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--hint); cursor: pointer; font-size: 10px;
            letter-spacing: 0.5px; width: 25%;
            transition: color 0.2s, transform 0.2s;
            font-family: 'Exo 2', sans-serif; font-weight: 600;
            text-transform: uppercase;
        }
        .nav-item.active {
            color: var(--accent);
            transform: translateY(-3px);
        }
        .nav-item.active svg { filter: drop-shadow(0 0 8px var(--accent)); }
        .nav-icon { margin-bottom: 5px; }

        /* ===== MODAL ===== */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(8px);
            z-index: 200; flex-direction: column; justify-content: flex-end;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: linear-gradient(180deg, var(--surface) 0%, var(--bg) 100%);
            border: 1px solid var(--border);
            border-bottom: none;
            width: 100%; height: 90vh;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            display: flex; flex-direction: column;
            animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }
        .modal-handle {
            width: 40px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 20px;
        }
        .modal-header {
            font-family: 'Orbitron', monospace;
            font-size: 16px; font-weight: 700;
            letter-spacing: 2px; color: var(--accent);
            text-shadow: 0 0 10px var(--glow);
            margin-bottom: 20px;
        }

        .input-field, select {
            width: 100%;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            margin-bottom: 12px;
            font-size: 15px;
            outline: none;
            font-family: 'Exo 2', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 16px var(--glow);
        }
        select option { background: var(--surface); }
        textarea.input-field { flex-grow: 1; resize: none; min-height: 120px; }

        label.field-label {
            display: block; font-size: 10px; letter-spacing: 2px;
            color: var(--hint); text-transform: uppercase;
            margin-bottom: 6px; margin-top: 2px;
        }

        .btn-row { display: flex; gap: 10px; margin-top: auto; padding-top: 16px; }
        .btn {
            flex: 1; padding: 14px; border-radius: 14px;
            border: none; font-size: 14px; font-weight: 700;
            font-family: 'Exo 2', sans-serif;
            letter-spacing: 1px; text-transform: uppercase;
            color: #fff; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-save {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            box-shadow: 0 4px 20px var(--glow);
        }
        .btn-save:active { box-shadow: 0 0 30px var(--glow); }
        .btn-cancel { background: var(--surface2); color: var(--hint); border: 1px solid var(--border); }
        .btn-delete { background: var(--danger); flex: 0 0 50px; font-size: 16px; padding: 14px 0; }

        /* ===== SETTINGS ===== */
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .theme-btn {
            padding: 18px 12px; border-radius: 16px; border: 1px solid var(--border);
            background: var(--surface); cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .theme-btn:active { transform: scale(0.95); }
        .theme-btn .theme-swatch {
            width: 36px; height: 36px; border-radius: 50%;
        }
        .theme-btn .theme-name {
            font-size: 12px; font-weight: 600; color: var(--text);
            font-family: 'Exo 2', sans-serif; text-align: center;
        }
        .settings-section-title {
            font-family: 'Orbitron', monospace;
            font-size: 11px; letter-spacing: 3px;
            color: var(--hint); text-transform: uppercase;
            margin-bottom: 4px; margin-top: 20px;
        }
        .info-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 16px;
            font-size: 12px; color: var(--hint); line-height: 1.6; margin-top: 8px;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center; padding-top: 60px; color: var(--hint);
        }
        .empty-state svg { opacity: 0.25; margin-bottom: 14px; }
        .empty-state p { font-size: 14px; letter-spacing: 1px; }

        /* ===== ATTACHED BADGE ===== */
        .attach-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-size: 11px; color: var(--hint);
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; padding: 3px 8px; margin-top: 7px;
        }
    </style>
</head>
<body>

    <!-- SPLASH -->
    <div id="splash">
        <div class="splash-text">AN1MK0</div>
        <div class="splash-sub">Personal Assistant v2.0</div>
    </div>

    <!-- STARFIELD -->
    <canvas id="starfield"></canvas>

    <!-- ===== PAGES ===== -->
    <div class="page">
        <div id="tab-notes" class="tab-content active">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>
                </svg>
                ЗАМЕТКИ
            </div>
            <div id="notes-list"></div>
        </div>

        <div id="tab-todos" class="tab-content">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                ЗАДАЧИ
            </div>
            <div id="todos-list"></div>
        </div>

        <div id="tab-reminders" class="tab-content">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                ТАЙМЕРЫ
            </div>
            <div id="reminders-list"></div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/>
                </svg>
                НАСТРОЙКИ
            </div>
            <div style="padding: 0 16px;">
                <div class="settings-section-title">Тема оформления</div>
                <div class="theme-grid">
                    <button class="theme-btn" onclick="setTheme('default')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #00d4ff, #7c3aed);"></div>
                        <span class="theme-name">Cyber Blue</span>
                    </button>
                    <button class="theme-btn" onclick="setTheme('neon')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #f72585, #7209b7);"></div>
                        <span class="theme-name">Neon Pink</span>
                    </button>
                    <button class="theme-btn" onclick="setTheme('hacker')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #00ff41, #008f11);"></div>
                        <span class="theme-name">Hacker</span>
                    </button>
                    <button class="theme-btn" onclick="setTheme('solar')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #ff9500, #ff3b00);"></div>
                        <span class="theme-name">Solar Flare</span>
                    </button>
                </div>
                <div class="settings-section-title" style="margin-top: 24px;">Информация</div>
                <div class="info-card">
                    Данные хранятся в облаке Telegram Cloud Storage и синхронизируются между устройствами автоматически.
                </div>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="fab-btn" onclick="openEditor()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
    </button>

    <!-- EDITOR MODAL -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div class="modal-header" id="modal-title">НОВАЯ ЗАПИСЬ</div>

            <label class="field-label">Название</label>
            <input type="text" id="edit-title" class="input-field" placeholder="Введите название...">

            <div id="desc-block">
                <label class="field-label">Описание</label>
                <textarea id="edit-desc" class="input-field" placeholder="Введите описание..."></textarea>
            </div>

            <div id="reminder-options" style="display: none;">
                <label class="field-label">Дата и время</label>
                <input type="datetime-local" step="1" id="edit-time" class="input-field">
                <label class="field-label">Прикрепить заметку / задачу</label>
                <select id="edit-attach" class="input-field">
                    <option value="">— Без привязки —</option>
                </select>
            </div>

            <div class="btn-row">
                <button class="btn btn-delete" id="btn-delete" onclick="deleteItem()" style="display:none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                    </svg>
                </button>
                <button class="btn btn-cancel" onclick="closeEditor()">Отмена</button>
                <button class="btn btn-save" onclick="saveItem()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('notes', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
            </span>
            Заметки
        </div>
        <div class="nav-item" onclick="switchTab('todos', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
            </span>
            Задачи
        </div>
        <div class="nav-item" onclick="switchTab('reminders', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
            </span>
            Таймеры
        </div>
        <div class="nav-item" onclick="switchTab('settings', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/>
                </svg>
            </span>
            Настройки
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let currentTab = 'notes';
        let editingId = null;
        let appData = { notes: [], todos: [], reminders: [] };

        // ===== CLOUD STORAGE =====
        function loadData() {
            try {
                tg.CloudStorage.getItem('an1mk0_data', (err, val) => {
                    if (!err && val) {
                        try { appData = JSON.parse(val); } catch(e) {}
                    }
                    renderList();
                });
                tg.CloudStorage.getItem('an1mk0_theme', (err, val) => {
                    if (!err && val) applyTheme(val);
                });
            } catch(e) {
                renderList();
            }
        }

        function saveDataToCloud() {
            try { tg.CloudStorage.setItem('an1mk0_data', JSON.stringify(appData)); } catch(e) {}
        }

        function setTheme(name) {
            applyTheme(name);
            try { tg.CloudStorage.setItem('an1mk0_theme', name); } catch(e) {}
        }

        function applyTheme(name) {
            const attr = name === 'default' ? '' : name;
            document.documentElement.setAttribute('data-theme', attr);
            // Redraw stars with new accent color
            initStars();
        }

        // ===== NAVIGATION =====
        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            el.classList.add('active');
            document.getElementById('fab-btn').style.display = tab === 'settings' ? 'none' : 'flex';
            renderList();
        }

        // ===== EDITOR =====
        function openEditor(id = null) {
            editingId = id;
            const modal = document.getElementById('editor-modal');
            const titleEl = document.getElementById('edit-title');
            const descEl = document.getElementById('edit-desc');
            const timeEl = document.getElementById('edit-time');
            const attachEl = document.getElementById('edit-attach');
            const remOpts = document.getElementById('reminder-options');
            const descBlock = document.getElementById('desc-block');
            const btnDel = document.getElementById('btn-delete');
            const modalTitle = document.getElementById('modal-title');

            // Populate attach dropdown
            attachEl.innerHTML = '<option value="">— Без привязки —</option>';
            [...appData.notes, ...appData.todos].forEach(item => {
                const label = item.type === 'note' ? 'Заметка' : 'Задача';
                attachEl.innerHTML += `<option value="${item.title}">[${label}] ${item.title}</option>`;
            });

            if (currentTab === 'reminders') {
                remOpts.style.display = 'block';
                descBlock.style.display = 'none';
                modalTitle.textContent = id !== null ? 'РЕДАКТИРОВАТЬ ТАЙМЕР' : 'НОВЫЙ ТАЙМЕР';
            } else {
                remOpts.style.display = 'none';
                descBlock.style.display = 'block';
                modalTitle.textContent = id !== null
                    ? (currentTab === 'notes' ? 'РЕДАКТИРОВАТЬ ЗАМЕТКУ' : 'РЕДАКТИРОВАТЬ ЗАДАЧУ')
                    : (currentTab === 'notes' ? 'НОВАЯ ЗАМЕТКА' : 'НОВАЯ ЗАДАЧА');
            }

            if (id !== null) {
                const item = appData[currentTab].find(i => i.id === id);
                if (!item) return;
                titleEl.value = item.title || '';
                if (currentTab === 'reminders') {
                    timeEl.value = item.time_str || '';
                    attachEl.value = item.attached || '';
                } else {
                    descEl.value = item.desc || '';
                }
                btnDel.style.display = 'flex';
            } else {
                titleEl.value = ''; descEl.value = ''; timeEl.value = ''; attachEl.value = '';
                btnDel.style.display = 'none';
            }

            modal.classList.add('open');
            setTimeout(() => titleEl.focus(), 400);
        }

        function closeEditor() {
            document.getElementById('editor-modal').classList.remove('open');
        }

        // ===== SAVE =====
        function saveItem() {
            const title = document.getElementById('edit-title').value.trim();
            if (!title) { tg.showAlert("Введите название!"); return; }

            const newItem = {
                id: editingId !== null ? editingId : Date.now(),
                type: currentTab === 'todos' ? 'todo' : currentTab === 'reminders' ? 'reminder' : 'note',
                title: title,
                date: new Date().toLocaleDateString('ru-RU')
            };

            if (currentTab === 'reminders') {
                const timeStr = document.getElementById('edit-time').value;
                if (!timeStr) { tg.showAlert("Выберите дату и время!"); return; }
                newItem.time_str = timeStr;
                newItem.timestamp = Math.floor(new Date(timeStr).getTime() / 1000);
                newItem.attached = document.getElementById('edit-attach').value;
            } else {
                newItem.desc = document.getElementById('edit-desc').value.trim();
            }

            if (editingId !== null) {
                const idx = appData[currentTab].findIndex(i => i.id === editingId);
                if (idx !== -1) appData[currentTab][idx] = newItem;
            } else {
                appData[currentTab].push(newItem);
            }

            saveDataToCloud();
            closeEditor();
            renderList();

            // Send to Lua bot
            const luaPayload = {
                action: 'save_' + newItem.type,
                title: newItem.title,
                name: newItem.title,
                desc: newItem.desc || "",
                text: newItem.desc || "",
                timestamp: newItem.timestamp || 0,
                attached: newItem.attached || ""
            };

            try {
                if (tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0) {
                    tg.sendData(JSON.stringify(luaPayload));
                }
            } catch(e) {}
        }

        // ===== DELETE =====
        function deleteItem() {
            tg.showConfirm("Удалить запись?", (confirmed) => {
                if (confirmed) {
                    appData[currentTab] = appData[currentTab].filter(i => i.id !== editingId);
                    saveDataToCloud();
                    closeEditor();
                    renderList();
                }
            });
        }

        // ===== RENDER =====
        function renderList() {
            if (currentTab === 'settings') return;
            const container = document.getElementById(currentTab + '-list');
            if (!container) return;
            const items = appData[currentTab];

            if (!items || items.length === 0) {
                const icons = {
                    notes: `<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`,
                    todos: `<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>`,
                    reminders: `<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`
                };
                const labels = { notes: 'Нет заметок', todos: 'Нет задач', reminders: 'Нет таймеров' };
                container.innerHTML = `<div class="empty-state">${icons[currentTab]}<p>${labels[currentTab]}</p></div>`;
                return;
            }

            container.innerHTML = '';
            items.slice().reverse().forEach(item => {
                let extra = '';
                if (currentTab === 'reminders') {
                    const dtStr = item.time_str ? item.time_str.replace('T', ' ').slice(0, 16) : '';
                    const attachHtml = item.attached
                        ? `<div class="attach-badge"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>${item.attached}</div>` : '';
                    extra = `<div class="card-meta"><span>${dtStr}</span><span class="countdown" id="cd-${item.id}">...</span></div>${attachHtml}`;
                } else {
                    extra = `
                        <div class="card-text">${item.desc || ''}</div>
                        <div class="card-meta"><span>Изменено: ${item.date}</span></div>
                    `;
                }

                container.innerHTML += `
                    <div class="card" onclick="openEditor(${item.id})">
                        <div class="card-accent-line"></div>
                        <div class="card-inner">
                            <div class="card-title">${item.title}</div>
                            ${extra}
                        </div>
                    </div>
                `;
            });
        }

        // ===== COUNTDOWN TIMERS =====
        setInterval(() => {
            if (currentTab !== 'reminders') return;
            const now = Math.floor(Date.now() / 1000);
            (appData.reminders || []).forEach(item => {
                const el = document.getElementById('cd-' + item.id);
                if (!el) return;
                const diff = (item.timestamp || 0) - now;
                if (diff <= 0) { el.innerText = '⚡ Время!'; return; }
                const d = Math.floor(diff / 86400);
                const h = Math.floor((diff % 86400) / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                el.innerText = d > 0 ? `${d}д ${h}ч ${m}м` : `${h}ч ${m}м ${s}с`;
            });
        }, 1000);

        // ===== STARFIELD =====
        let stars = [];
        let starAnimId;

        function getAccentColor() {
            return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#00d4ff';
        }

        function initStars() {
            cancelAnimationFrame(starAnimId);
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            stars = [];
            const accentColor = getAccentColor();

            // Side-shooting stars (left and right edges)
            for (let i = 0; i < 80; i++) {
                stars.push({
                    // Distribute along height, spawn from left or right
                    x: Math.random() < 0.5 ? -10 : canvas.width + 10,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5 + 0.3,
                    speed: Math.random() * 1.2 + 0.4,
                    dirX: 0,
                    dirY: Math.random() * 0.6 + 0.2,
                    opacity: Math.random() * 0.6 + 0.4,
                    pulse: Math.random() * Math.PI * 2,
                    type: 'side'
                });
            }

            // Center falling stars
            for (let i = 0; i < 60; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.2 + 0.2,
                    speed: Math.random() * 0.8 + 0.2,
                    dirX: (Math.random() - 0.5) * 0.3,
                    dirY: 1,
                    opacity: Math.random() * 0.5 + 0.2,
                    pulse: Math.random() * Math.PI * 2,
                    type: 'fall'
                });
            }

            // Shooting stars (rare, fast)
            let shootingStars = [];
            for (let i = 0; i < 3; i++) {
                shootingStars.push(createShootingStar(canvas));
            }

            function hexToRgb(hex) {
                hex = hex.replace('#','');
                if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
                const n = parseInt(hex, 16);
                return [(n >> 16) & 255, (n >> 8) & 255, n & 255];
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const accent = getAccentColor();
                const rgb = hexToRgb(accent);

                // Regular stars
                stars.forEach(s => {
                    s.pulse += 0.03;
                    const glow = Math.sin(s.pulse) * 0.4 + 0.6;
                    const alpha = s.opacity * glow;

                    // Neon glow layers
                    const gradient = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.size * 5);
                    gradient.addColorStop(0, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha})`);
                    gradient.addColorStop(0.4, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha * 0.4})`);
                    gradient.addColorStop(1, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},0)`);

                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size * 5, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();

                    // Core bright dot
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255,255,255,${alpha * 0.9})`;
                    ctx.fill();

                    // Move
                    s.x += s.dirX * s.speed;
                    s.y += s.dirY * s.speed;

                    // Reset
                    if (s.type === 'side') {
                        if (s.y > canvas.height + 5) {
                            s.y = -5;
                            s.x = Math.random() < 0.5 ? Math.random() * canvas.width * 0.15 : canvas.width - Math.random() * canvas.width * 0.15;
                        }
                    } else {
                        if (s.y > canvas.height + 5) { s.y = -5; s.x = Math.random() * canvas.width; }
                        if (s.x < -5) s.x = canvas.width + 5;
                        if (s.x > canvas.width + 5) s.x = -5;
                    }
                });

                // Shooting stars
                shootingStars.forEach((ss, i) => {
                    ss.progress += ss.speed;
                    if (ss.progress >= 1) {
                        shootingStars[i] = createShootingStar(canvas);
                        return;
                    }
                    const cx = ss.x + ss.dx * ss.progress;
                    const cy = ss.y + ss.dy * ss.progress;
                    const tailLen = 60;
                    const tx = cx - ss.dx * 0.15 * tailLen / Math.hypot(ss.dx, ss.dy);
                    const ty = cy - ss.dy * 0.15 * tailLen / Math.hypot(ss.dx, ss.dy);

                    const grad = ctx.createLinearGradient(tx, ty, cx, cy);
                    grad.addColorStop(0, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},0)`);
                    grad.addColorStop(1, `rgba(255,255,255,0.85)`);

                    ctx.beginPath();
                    ctx.moveTo(tx, ty);
                    ctx.lineTo(cx, cy);
                    ctx.strokeStyle = grad;
                    ctx.lineWidth = 1.5;
                    ctx.stroke();

                    // Head glow
                    const hgrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 4);
                    hgrad.addColorStop(0, `rgba(255,255,255,0.9)`);
                    hgrad.addColorStop(1, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},0)`);
                    ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2);
                    ctx.fillStyle = hgrad; ctx.fill();
                });

                starAnimId = requestAnimationFrame(animate);
            }
            animate();
        }

        function createShootingStar(canvas) {
            const angle = Math.random() * Math.PI * 0.5 + Math.PI * 0.1;
            const dist = Math.sqrt(canvas.width**2 + canvas.height**2);
            return {
                x: Math.random() * canvas.width * 0.7,
                y: Math.random() * canvas.height * 0.5,
                dx: Math.cos(angle) * dist * 0.4,
                dy: Math.sin(angle) * dist * 0.4,
                speed: Math.random() * 0.005 + 0.003,
                progress: Math.random()
            };
        }

        window.addEventListener('resize', initStars);

        // ===== BOOT =====
        loadData();
        initStars();
    </script>
</body>
</html>
