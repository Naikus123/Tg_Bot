<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>An1mk0 Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080c14;
            --surface: #0f1623;
            --surface2: #161f30;
            --text: #e8f0fe;
            --hint: #5c7080;
            --accent: #00d4ff;
            --accent2: #7c3aed;
            --glow: rgba(0, 212, 255, 0.4);
            --danger: #ff4757;
            --border: rgba(0, 212, 255, 0.15);
        }
        [data-theme="neon"] {
            --bg: #0a0015;
            --surface: #12002a;
            --surface2: #1a003d;
            --accent: #f72585;
            --accent2: #7209b7;
            --glow: rgba(247, 37, 133, 0.4);
            --border: rgba(247, 37, 133, 0.2);
            --text: #fce4ff;
        }
        [data-theme="hacker"] {
            --bg: #010a01;
            --surface: #021402;
            --surface2: #031f03;
            --accent: #00ff41;
            --accent2: #008f11;
            --glow: rgba(0, 255, 65, 0.35);
            --border: rgba(0, 255, 65, 0.15);
            --text: #ccffcc;
            --hint: #3d7a3d;
        }
        [data-theme="solar"] {
            --bg: #0c0800;
            --surface: #1a1000;
            --surface2: #251800;
            --accent: #ff9500;
            --accent2: #ff3b00;
            --glow: rgba(255, 149, 0, 0.4);
            --border: rgba(255, 149, 0, 0.2);
            --text: #fff8ec;
            --hint: #7a5c20;
        }
        /* Ghost - dim violet, glitchy hacker feel */
        [data-theme="ghost"] {
            --bg: #07060f;
            --surface: #100e1e;
            --surface2: #18162c;
            --accent: #a78bfa;
            --accent2: #4f46e5;
            --glow: rgba(167, 139, 250, 0.4);
            --border: rgba(167, 139, 250, 0.15);
            --text: #ede9fe;
            --hint: #6d6489;
        }
        [data-theme="ghost"] body { font-family: 'Courier New', monospace; }
        [data-theme="ghost"] .card-title,
        [data-theme="ghost"] .header { font-family: 'Courier New', monospace; letter-spacing: 1px; }
        [data-theme="ghost"] .card { border-style: dashed; }
        [data-theme="ghost"] .card-accent-line { animation: ghostFlicker 3s infinite; }
        @keyframes ghostFlicker {
            0%,100% { opacity: 1; }
            92% { opacity: 1; }
            93% { opacity: 0; }
            94% { opacity: 1; }
            96% { opacity: 0; }
            97% { opacity: 1; }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            padding-bottom: 85px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ===== STARFIELD ===== */
        #starfield {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0; pointer-events: none;
        }

        /* ===== SPLASH ===== */
        #splash {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
            animation: splashExit 0.5s 2.2s forwards;
        }
        .splash-text {
            font-family: 'Orbitron', monospace;
            font-size: 36px; font-weight: 900;
            letter-spacing: 8px;
            color: var(--accent);
            text-shadow: 0 0 20px var(--accent), 0 0 60px var(--accent), 0 0 120px var(--accent);
            animation: splashGlow 0.4s ease-in-out infinite alternate;
        }
        .splash-sub {
            font-family: 'Exo 2', sans-serif;
            font-size: 11px; letter-spacing: 6px;
            color: var(--hint); margin-top: 10px;
            text-transform: uppercase;
            animation: fadeInUp 0.6s 0.4s both;
        }
        @keyframes splashGlow {
            from { text-shadow: 0 0 10px var(--accent), 0 0 40px var(--accent); }
            to   { text-shadow: 0 0 25px var(--accent), 0 0 80px var(--accent), 0 0 150px var(--accent); }
        }
        @keyframes splashExit {
            to { opacity: 0; pointer-events: none; visibility: hidden; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== LAYOUT ===== */
        .page { position: relative; z-index: 1; }

        .header {
            padding: 22px 20px 14px;
            font-family: 'Orbitron', monospace;
            font-size: 20px; font-weight: 700;
            letter-spacing: 2px;
            position: sticky; top: 0; z-index: 10;
            background: linear-gradient(to bottom, var(--bg) 70%, transparent);
            backdrop-filter: blur(12px);
            display: flex; align-items: center; gap: 12px;
            color: var(--accent);
            text-shadow: 0 0 12px var(--glow);
            border-bottom: 1px solid var(--border);
        }
        .header svg { filter: drop-shadow(0 0 6px var(--accent)); }

        /* ===== TABS ===== */
        .tab-content { display: none; padding: 16px; animation: fadeSlide 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== CARDS ===== */
        .card {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px 18px;
            margin-bottom: 12px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .card::before {
            content: '';
            position: absolute; top: 0; left: -100%;
            width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
            transition: left 0.4s;
        }
        .card:hover::before { left: 150%; }
        .card:active { transform: scale(0.97); box-shadow: 0 0 20px var(--glow); border-color: var(--accent); }

        .card-accent-line {
            position: absolute; left: 0; top: 0; bottom: 0;
            width: 3px; background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            border-radius: 3px 0 0 3px;
        }
        .card-inner { padding-left: 12px; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; letter-spacing: 0.5px; }
        .card-text {
            font-size: 13px; color: var(--hint);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.4;
        }
        .card-meta {
            font-size: 11px; color: var(--accent);
            margin-top: 10px; display: flex;
            justify-content: space-between; align-items: center;
            opacity: 0.8; letter-spacing: 0.5px;
        }
        .countdown {
            font-family: 'Orbitron', monospace;
            font-size: 10px; color: var(--accent);
            text-shadow: 0 0 8px var(--glow);
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ===== FAB ===== */
        .fab {
            position: fixed; bottom: 98px; right: 20px;
            width: 54px; height: 54px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff; border: none; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px var(--glow), 0 0 40px var(--glow);
            cursor: pointer; z-index: 100;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fab:active { transform: scale(0.85) rotate(45deg); box-shadow: 0 0 40px var(--glow); }

        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(8, 12, 20, 0.95);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 10px 0 18px;
            border-top: 1px solid var(--border);
            z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--hint); cursor: pointer; font-size: 10px;
            letter-spacing: 0.5px; width: 25%;
            transition: color 0.2s, transform 0.2s;
            font-family: 'Exo 2', sans-serif; font-weight: 600;
            text-transform: uppercase;
        }
        .nav-item.active {
            color: var(--accent);
            transform: translateY(-3px);
        }
        .nav-item.active svg { filter: drop-shadow(0 0 8px var(--accent)); }
        .nav-icon { margin-bottom: 5px; }

        /* ===== MODAL ===== */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(8px);
            z-index: 200; flex-direction: column; justify-content: flex-end;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: linear-gradient(180deg, var(--surface) 0%, var(--bg) 100%);
            border: 1px solid var(--border);
            border-bottom: none;
            width: 100%; height: 90vh;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            display: flex; flex-direction: column;
            animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }
        .modal-handle {
            width: 40px; height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 20px;
        }
        .modal-header {
            font-family: 'Orbitron', monospace;
            font-size: 16px; font-weight: 700;
            letter-spacing: 2px; color: var(--accent);
            text-shadow: 0 0 10px var(--glow);
            margin-bottom: 20px;
        }

        .input-field, select {
            width: 100%;
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            margin-bottom: 12px;
            font-size: 15px;
            outline: none;
            font-family: 'Exo 2', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 16px var(--glow);
        }
        select option { background: var(--surface); }
        textarea.input-field { flex-grow: 1; resize: none; min-height: 120px; }

        label.field-label {
            display: block; font-size: 10px; letter-spacing: 2px;
            color: var(--hint); text-transform: uppercase;
            margin-bottom: 6px; margin-top: 2px;
        }

        .btn-row { display: flex; gap: 10px; margin-top: auto; padding-top: 16px; }
        .btn {
            flex: 1; padding: 14px; border-radius: 14px;
            border: none; font-size: 14px; font-weight: 700;
            font-family: 'Exo 2', sans-serif;
            letter-spacing: 1px; text-transform: uppercase;
            color: #fff; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-save {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            box-shadow: 0 4px 20px var(--glow);
        }
        .btn-save:active { box-shadow: 0 0 30px var(--glow); }
        .btn-cancel { background: var(--surface2); color: var(--hint); border: 1px solid var(--border); }
        .btn-delete { background: var(--danger); flex: 0 0 50px; font-size: 16px; padding: 14px 0; }

        /* ===== SETTINGS ===== */
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .theme-btn {
            padding: 18px 12px; border-radius: 16px; border: 1px solid var(--border);
            background: var(--surface); cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .theme-btn:active { transform: scale(0.95); }
        .theme-btn .theme-swatch {
            width: 36px; height: 36px; border-radius: 50%;
        }
        .theme-btn .theme-name {
            font-size: 12px; font-weight: 600; color: var(--text);
            font-family: 'Exo 2', sans-serif; text-align: center;
        }
        .settings-section-title {
            font-family: 'Orbitron', monospace;
            font-size: 11px; letter-spacing: 3px;
            color: var(--hint); text-transform: uppercase;
            margin-bottom: 4px; margin-top: 20px;
        }
        .info-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 16px;
            font-size: 12px; color: var(--hint); line-height: 1.6; margin-top: 8px;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center; padding-top: 60px; color: var(--hint);
        }
        .empty-state svg { opacity: 0.25; margin-bottom: 14px; }
        .empty-state p { font-size: 14px; letter-spacing: 1px; }

        /* ===== ATTACHED BADGE ===== */
        .attach-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-size: 11px; color: var(--hint);
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; padding: 3px 8px; margin-top: 7px;
        }

        /* ===== SETTINGS BG TOGGLE ===== */
        .bg-toggle-row { display: flex; gap: 12px; margin-top: 12px; }
        .bg-toggle-btn {
            flex: 1; padding: 14px 10px; border-radius: 14px;
            border: 1px solid var(--border); background: var(--surface);
            color: var(--hint); cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            font-size: 12px; font-weight: 600; font-family: 'Exo 2', sans-serif;
        }
        .bg-toggle-btn:active { transform: scale(0.95); }
        .bg-toggle-btn.active {
            border-color: var(--accent); color: var(--accent);
            background: var(--surface2); box-shadow: 0 0 14px var(--glow);
        }
        .theme-btn.active-theme {
            border-color: var(--accent);
            box-shadow: 0 0 14px var(--glow);
        }

        /* ===== CUSTOM PICKERS ===== */
        .custom-field {
            display: flex; align-items: center; gap: 10px;
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 16px; margin-bottom: 12px;
            cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--hint); font-size: 15px; font-family: 'Exo 2', sans-serif;
            user-select: none;
        }
        .custom-field:active { border-color: var(--accent); box-shadow: 0 0 14px var(--glow); }
        .custom-field.filled { color: var(--text); border-color: rgba(255,255,255,0.15); }
        .custom-field span { flex: 1; }
        .field-arrow { margin-left: auto; opacity: 0.5; }

        /* Attach dropdown */
        .custom-dropdown {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 14px; overflow: hidden; margin-bottom: 12px;
            animation: fadeSlide 0.2s ease;
        }
        .dropdown-item {
            padding: 13px 16px; font-size: 14px; color: var(--text);
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid var(--border); transition: background 0.15s;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:active { background: var(--surface); }
        .dropdown-item.selected { color: var(--accent); }
        .dropdown-item .item-badge {
            font-size: 10px; letter-spacing: 1px; color: var(--hint);
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 6px; padding: 2px 6px;
        }

        /* Picker overlays */
        .picker-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px); z-index: 500;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .picker-sheet {
            background: linear-gradient(180deg, var(--surface) 0%, var(--bg) 100%);
            border: 1px solid var(--border); border-bottom: none;
            border-radius: 24px 24px 0 0; width: 100%; padding: 24px;
            animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .picker-title {
            font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700;
            letter-spacing: 3px; color: var(--accent);
            text-shadow: 0 0 10px var(--glow); text-align: center; margin-bottom: 20px;
        }
        .picker-btn-row { display: flex; gap: 10px; margin-top: 20px; }

        /* ===== CALENDAR ===== */
        .cal-nav {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 16px;
        }
        .cal-nav-btn {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 10px; padding: 8px 12px; color: var(--text);
            cursor: pointer; transition: 0.15s;
        }
        .cal-nav-btn:active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .cal-month-label {
            font-family: 'Orbitron', monospace; font-size: 13px;
            color: var(--text); letter-spacing: 1px;
        }
        .cal-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; margin-bottom: 8px;
        }
        .cal-weekdays span {
            font-size: 11px; color: var(--hint); font-weight: 600;
            letter-spacing: 0.5px; padding: 4px 0;
        }
        .cal-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .cal-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 10px; font-size: 14px; cursor: pointer;
            transition: 0.15s; color: var(--text); font-family: 'Exo 2', sans-serif;
        }
        .cal-day:active { background: var(--surface2); }
        .cal-day.empty { cursor: default; }
        .cal-day.other-month { color: var(--hint); opacity: 0.4; }
        .cal-day.today { color: var(--accent); font-weight: 700; }
        .cal-day.today::after {
            content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%; background: var(--accent);
        }
        .cal-day { position: relative; }
        .cal-day.selected {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff; box-shadow: 0 0 12px var(--glow); font-weight: 700;
        }
        .cal-day.past { opacity: 0.3; cursor: default; }

        /* ===== DRUM TIME PICKER ===== */
        .time-picker-wrap {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            height: 240px; padding: 0 2px;
        }
        .drum-col { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; height: 100%; min-width: 0; }
        .drum-label { font-size: 9px; letter-spacing: 2px; color: var(--hint); text-transform: uppercase; flex-shrink: 0; }
        .drum-sep {
            font-size: 24px; font-family: 'Orbitron', monospace;
            color: var(--accent); padding-top: 24px; opacity: 0.8; flex-shrink: 0; width: 14px; text-align: center;
        }
        .drum-wrap {
            flex: 1; width: 100%; position: relative; border-radius: 14px;
            overflow: hidden; border: 1px solid var(--border); cursor: grab;
        }
        .drum-wrap:active { cursor: grabbing; }
        .drum {
            width: 100%; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory;
            background: var(--surface2); scrollbar-width: none;
            /* prevent native scroll interference on desktop */
            overscroll-behavior: contain;
        }
        .drum::-webkit-scrollbar { display: none; }
        .drum-wrap::before, .drum-wrap::after {
            content: ''; position: absolute; left: 0; right: 0; height: 72px;
            z-index: 2; pointer-events: none;
        }
        .drum-wrap::before { top: 0; background: linear-gradient(to bottom, var(--surface2) 15%, transparent); }
        .drum-wrap::after  { bottom: 0; background: linear-gradient(to top, var(--surface2) 15%, transparent); }
        .drum-selector {
            position: absolute; top: 50%; left: 0; right: 0; height: 48px;
            transform: translateY(-50%);
            border-top: 1px solid var(--accent); border-bottom: 1px solid var(--accent);
            box-shadow: 0 0 14px var(--glow); pointer-events: none; z-index: 3;
        }
        .drum-item {
            height: 48px; display: flex; align-items: center; justify-content: center;
            scroll-snap-align: center; font-size: 20px; font-family: 'Orbitron', monospace;
            color: var(--hint); font-weight: 700; user-select: none; pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- SPLASH -->
    <div id="splash">
        <div class="splash-text">AN1MK0</div>
        <div class="splash-sub">Personal Assistant v2.0</div>
    </div>

    <!-- STARFIELD -->
    <canvas id="starfield"></canvas>

    <!-- ===== PAGES ===== -->
    <div class="page">
        <div id="tab-notes" class="tab-content active">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>
                </svg>
                ЗАМЕТКИ
            </div>
            <div id="notes-list"></div>
        </div>

        <div id="tab-todos" class="tab-content">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                ЗАДАЧИ
            </div>
            <div id="todos-list"></div>
        </div>

        <div id="tab-reminders" class="tab-content">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                ТАЙМЕРЫ
            </div>
            <div id="reminders-list"></div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="header">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/>
                </svg>
                НАСТРОЙКИ
            </div>
            <div style="padding: 0 16px;">
                <div class="settings-section-title">Тема оформления</div>
                <div class="theme-grid">
                    <button class="theme-btn" id="theme-btn-default" onclick="setTheme('default')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #00d4ff, #7c3aed);"></div>
                        <span class="theme-name">Cyber Blue</span>
                    </button>
                    <button class="theme-btn" id="theme-btn-neon" onclick="setTheme('neon')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #f72585, #7209b7);"></div>
                        <span class="theme-name">Neon Pink</span>
                    </button>
                    <button class="theme-btn" id="theme-btn-hacker" onclick="setTheme('hacker')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #00ff41, #008f11);"></div>
                        <span class="theme-name">Hacker</span>
                    </button>
                    <button class="theme-btn" id="theme-btn-solar" onclick="setTheme('solar')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #ff9500, #ff3b00);"></div>
                        <span class="theme-name">Solar Flare</span>
                    </button>
                    <button class="theme-btn" id="theme-btn-ghost" onclick="setTheme('ghost')">
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #a78bfa, #4f46e5);"></div>
                        <span class="theme-name">Ghost</span>
                    </button>
                </div>

                <div class="settings-section-title" style="margin-top: 24px;">Фон</div>
                <div class="bg-toggle-row">
                    <button class="bg-toggle-btn" id="bg-btn-meteor" onclick="setBgMode('meteor')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M5 19L19 5M12 5l7 7-7 7"/></svg>
                        <span>Метеоры</span>
                    </button>
                    <button class="bg-toggle-btn" id="bg-btn-neonfield" onclick="setBgMode('neonfield')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                        <span>Неон</span>
                    </button>
                </div>

                <div class="settings-section-title" style="margin-top: 24px;">Информация</div>
                <div class="info-card">
                    Данные хранятся в облаке Telegram Cloud Storage и синхронизируются между устройствами автоматически.
                </div>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="fab-btn" onclick="openEditor()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
    </button>

    <!-- EDITOR MODAL -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div class="modal-header" id="modal-title">НОВАЯ ЗАПИСЬ</div>

            <label class="field-label">Название</label>
            <input type="text" id="edit-title" class="input-field" placeholder="Введите название...">

            <div id="desc-block">
                <label class="field-label">Описание</label>
                <textarea id="edit-desc" class="input-field" placeholder="Введите описание..."></textarea>
            </div>

            <div id="reminder-options" style="display: none;">
                <label class="field-label">Дата и время</label>
                <div class="custom-field" id="date-display" onclick="openCalendar()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span id="date-display-text">Выбрать дату</span>
                    <svg class="field-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="custom-field" id="time-display" onclick="openTimePicker()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="time-display-text">Выбрать время</span>
                    <svg class="field-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>

                <label class="field-label">Прикрепить заметку / задачу</label>
                <div class="custom-field" id="attach-display" onclick="toggleAttachDropdown()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    <span id="attach-display-text">— Без привязки —</span>
                    <svg class="field-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div id="attach-dropdown" class="custom-dropdown" style="display:none;"></div>
            </div>

            <div class="btn-row">
                <button class="btn btn-delete" id="btn-delete" onclick="deleteItem()" style="display:none;align-items:center;justify-content:center;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
                <button class="btn btn-cancel" onclick="closeEditor()">Отмена</button>
                <button class="btn btn-save" onclick="saveItem()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- VIEW MODAL (fullscreen read) -->
    <div id="view-modal" class="view-modal">
        <div class="view-topbar">
            <button class="view-back-btn" onclick="closeView()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <div class="view-topbar-title" id="view-topbar-title">ПРОСМОТР</div>
            <button class="view-edit-btn" onclick="editFromView()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Изменить
            </button>
        </div>
        <div class="view-body" id="view-body"></div>
    </div>

    <!-- CALENDAR OVERLAY -->
    <div id="calendar-overlay" class="picker-overlay" style="display:none;">
        <div class="picker-sheet">
            <div class="picker-title">ВЫБОР ДАТЫ</div>
            <div class="cal-nav">
                <button class="cal-nav-btn" onclick="calNav(-1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <span id="cal-month-label" class="cal-month-label"></span>
                <button class="cal-nav-btn" onclick="calNav(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                </button>
            </div>
            <div class="cal-weekdays">
                <span>Пн</span><span>Вт</span><span>Ср</span><span>Чт</span><span>Пт</span>
                <span style="color:var(--accent)">Сб</span><span style="color:var(--accent)">Вс</span>
            </div>
            <div id="cal-grid" class="cal-grid"></div>
            <div class="picker-btn-row">
                <button class="btn btn-cancel" onclick="closeCalendar()">Отмена</button>
                <button class="btn btn-save" onclick="confirmCalendar()">Выбрать</button>
            </div>
        </div>
    </div>

    <!-- TIME PICKER OVERLAY -->
    <div id="time-overlay" class="picker-overlay" style="display:none;">
        <div class="picker-sheet">
            <div class="picker-title">ВЫБОР ВРЕМЕНИ</div>
            <div class="time-picker-wrap">
                <div class="drum-col">
                    <div class="drum-label">Часы</div>
                    <div class="drum-wrap" id="wrap-h">
                        <div class="drum-selector"></div>
                        <div class="drum" id="drum-h"></div>
                    </div>
                </div>
                <div class="drum-sep">:</div>
                <div class="drum-col">
                    <div class="drum-label">Минуты</div>
                    <div class="drum-wrap" id="wrap-m">
                        <div class="drum-selector"></div>
                        <div class="drum" id="drum-m"></div>
                    </div>
                </div>
                <div class="drum-sep">:</div>
                <div class="drum-col">
                    <div class="drum-label">Секунды</div>
                    <div class="drum-wrap" id="wrap-s">
                        <div class="drum-selector"></div>
                        <div class="drum" id="drum-s"></div>
                    </div>
                </div>
            </div>
            <div class="picker-btn-row">
                <button class="btn btn-cancel" onclick="closeTimePicker()">Отмена</button>
                <button class="btn btn-save" onclick="confirmTime()">Выбрать</button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('notes', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
            </span>
            Заметки
        </div>
        <div class="nav-item" onclick="switchTab('todos', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
            </span>
            Задачи
        </div>
        <div class="nav-item" onclick="switchTab('reminders', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
            </span>
            Таймеры
        </div>
        <div class="nav-item" onclick="switchTab('settings', this)">
            <span class="nav-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/>
                </svg>
            </span>
            Настройки
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let currentTab = 'notes';
        let editingId = null;
        let appData = { notes: [], todos: [], reminders: [] };

        // ===== CLOUD STORAGE =====
        function loadData() {
            try {
                tg.CloudStorage.getItem('an1mk0_data', (err, val) => {
                    if (!err && val) {
                        try { appData = JSON.parse(val); } catch(e) {}
                    }
                    renderList();
                });
                tg.CloudStorage.getItem('an1mk0_theme', (err, val) => {
                    if (!err && val) {
                        currentTheme = val;
                        applyTheme(val);
                        const btn = document.getElementById('theme-btn-' + val);
                        if (btn) btn.classList.add('active-theme');
                    }
                });
                tg.CloudStorage.getItem('an1mk0_bg', (err, val) => {
                    if (!err && val) setBgMode(val);
                    else setBgMode('meteor');
                });
            } catch(e) {
                renderList();
            }
        }

        function saveDataToCloud() {
            try { tg.CloudStorage.setItem('an1mk0_data', JSON.stringify(appData)); } catch(e) {}
        }

        let currentBgMode = 'meteor'; // 'meteor' | 'neonfield'
        let currentTheme = 'default';

        function setTheme(name) {
            currentTheme = name;
            applyTheme(name);
            try { tg.CloudStorage.setItem('an1mk0_theme', name); } catch(e) {}
            // Update active button
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active-theme'));
            const btn = document.getElementById('theme-btn-' + name);
            if (btn) btn.classList.add('active-theme');
        }

        function applyTheme(name) {
            const attr = name === 'default' ? '' : name;
            document.documentElement.setAttribute('data-theme', attr);
            initBackground();
        }

        function setBgMode(mode) {
            currentBgMode = mode;
            document.querySelectorAll('.bg-toggle-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('bg-btn-' + mode);
            if (btn) btn.classList.add('active');
            try { tg.CloudStorage.setItem('an1mk0_bg', mode); } catch(e) {}
            initBackground();
        }

        function initBackground() {
            if (currentBgMode === 'neonfield') {
                initNeonField();
            } else {
                initStars();
            }
        }

        // ===== NAVIGATION =====
        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            el.classList.add('active');
            document.getElementById('fab-btn').style.display = tab === 'settings' ? 'none' : 'flex';
            renderList();
        }

        // ===== CUSTOM PICKER STATE =====
        let pickerDate = null;   // { year, month, day }
        let pickerTime = null;   // { h, m }
        let pickerAttach = [];   // array of attached titles
        let calViewYear, calViewMonth;

                function getPickerDateTimeString() {
            if (!pickerDate || !pickerTime) return null;
            const y  = pickerDate.year;
            const mo = String(pickerDate.month + 1).padStart(2,'0');
            const d  = String(pickerDate.day).padStart(2,'0');
            const h  = String(pickerTime.h).padStart(2,'0');
            const m  = String(pickerTime.m).padStart(2,'0');
            const s  = String(pickerTime.s || 0).padStart(2,'0');
            return `${y}-${mo}-${d}T${h}:${m}:${s}`;
        }-${mo}-${d}T${h}:${m}`;
        }

        function updateDateDisplay() {
            const el = document.getElementById('date-display');
            const txt = document.getElementById('date-display-text');
            if (pickerDate) {
                const months = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
                const wdays = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
                const d = new Date(pickerDate.year, pickerDate.month, pickerDate.day);
                const wd = (d.getDay() + 6) % 7;
                txt.textContent = `${wdays[wd]}, ${pickerDate.day} ${months[pickerDate.month]} ${pickerDate.year}`;
                el.classList.add('filled');
            } else {
                txt.textContent = 'Выбрать дату';
                el.classList.remove('filled');
            }
        }

        function updateTimeDisplay() {
            const el = document.getElementById('time-display');
            const txt = document.getElementById('time-display-text');
            if (pickerTime) {
                const h = String(pickerTime.h).padStart(2,'0');
                const m = String(pickerTime.m).padStart(2,'0');
                const s = String(pickerTime.s || 0).padStart(2,'0');
                txt.textContent = `${h}:${m}:${s}`;
                el.classList.add('filled');
            } else {
                txt.textContent = 'Выбрать время';
                el.classList.remove('filled');
            }
        }

        // ===== CALENDAR =====
        let calSelected = null; // {year,month,day}

        function openCalendar() {
            const now = new Date();
            calViewYear  = pickerDate ? pickerDate.year  : now.getFullYear();
            calViewMonth = pickerDate ? pickerDate.month : now.getMonth();
            calSelected  = pickerDate ? {...pickerDate} : null;
            renderCalendar();
            document.getElementById('calendar-overlay').style.display = 'flex';
        }
        function closeCalendar() { document.getElementById('calendar-overlay').style.display = 'none'; }
        function confirmCalendar() {
            if (!calSelected) { tg.showAlert('Выберите дату!'); return; }
            pickerDate = {...calSelected};
            updateDateDisplay();
            closeCalendar();
        }
        function calNav(dir) {
            calViewMonth += dir;
            if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; }
            if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; }
            renderCalendar();
        }
        function renderCalendar() {
            const MONTHS = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
            document.getElementById('cal-month-label').textContent = `${MONTHS[calViewMonth]} ${calViewYear}`;
            const grid = document.getElementById('cal-grid');
            grid.innerHTML = '';
            const now = new Date(); now.setHours(0,0,0,0);

            // First weekday of month (Mon=0)
            const firstDay = new Date(calViewYear, calViewMonth, 1);
            let startWd = (firstDay.getDay() + 6) % 7; // 0=Mon

            const daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();
            const prevDays = new Date(calViewYear, calViewMonth, 0).getDate();

            let cells = [];
            // Previous month filler
            for (let i = startWd - 1; i >= 0; i--) {
                cells.push({ day: prevDays - i, month: calViewMonth - 1, year: calViewYear, cls: 'other-month' });
            }
            // Current month
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(calViewYear, calViewMonth, d);
                const isPast = date < now;
                const isToday = date.getTime() === now.getTime();
                const isSel = calSelected && calSelected.year === calViewYear && calSelected.month === calViewMonth && calSelected.day === d;
                let cls = '';
                if (isPast) cls = 'past';
                else if (isSel) cls = 'selected';
                else if (isToday) cls = 'today';
                cells.push({ day: d, month: calViewMonth, year: calViewYear, cls });
            }
            // Next month filler
            let rem = 7 - (cells.length % 7);
            if (rem === 7) rem = 0;
            for (let i = 1; i <= rem; i++) {
                cells.push({ day: i, month: calViewMonth + 1, year: calViewYear, cls: 'other-month' });
            }

            cells.forEach(c => {
                const el = document.createElement('div');
                el.className = 'cal-day ' + (c.cls || '');
                el.textContent = c.day;
                if (!c.cls.includes('past') && !c.cls.includes('other-month')) {
                    el.onclick = () => {
                        calSelected = { year: c.year, month: c.month, day: c.day };
                        renderCalendar();
                    };
                } else if (c.cls === 'other-month') {
                    el.onclick = () => {
                        calViewMonth = c.month; calViewYear = c.year;
                        if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; }
                        if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; }
                        calSelected = { year: c.year, month: c.month < 0 ? 11 : c.month > 11 ? 0 : c.month, day: c.day };
                        renderCalendar();
                    };
                }
                grid.appendChild(el);
            });
        }

        // ===== DRUM TIME PICKER =====
        const ITEM_H = 48;
        const GHOST = 2;  // ghost rows top/bottom so 0 and max are centerable
        const DRUMS = [
            { id: 'drum-h', wrapId: 'wrap-h', count: 24 },
            { id: 'drum-m', wrapId: 'wrap-m', count: 60 },
            { id: 'drum-s', wrapId: 'wrap-s', count: 60 },
        ];

        function buildDrum(id, count) {
            const drum = document.getElementById(id);
            drum.innerHTML = '';
            for (let p = 0; p < GHOST; p++) {
                const g = document.createElement('div');
                g.className = 'drum-item'; drum.appendChild(g);
            }
            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.className = 'drum-item';
                el.textContent = String(i).padStart(2, '0');
                drum.appendChild(el);
            }
            for (let p = 0; p < GHOST; p++) {
                const g = document.createElement('div');
                g.className = 'drum-item'; drum.appendChild(g);
            }
        }

        function snapDrum(drum, maxVal) {
            // Snap to nearest item after wheel/drag
            const raw = drum.scrollTop / ITEM_H;
            const snapped = Math.max(0, Math.min(maxVal - 1, Math.round(raw)));
            drum.scrollTo({ top: snapped * ITEM_H, behavior: 'smooth' });
        }

        function getDrumValue(drum, maxVal) {
            const val = Math.round(drum.scrollTop / ITEM_H);
            return Math.max(0, Math.min(maxVal - 1, val));
        }

        function highlightDrum(drum, maxVal) {
            const active = getDrumValue(drum, maxVal);
            drum.querySelectorAll('.drum-item').forEach((el, idx) => {
                const ri = idx - GHOST;
                const dist = Math.abs(ri - active);
                const isActive = ri === active;
                el.style.color    = isActive ? 'var(--text)' : 'var(--hint)';
                el.style.fontSize = isActive ? '24px' : dist === 1 ? '18px' : '15px';
                el.style.opacity  = isActive ? '1'   : dist === 1 ? '0.55' : '0.25';
            });
        }

        function attachDrumControls(drum, maxVal) {
            // ── MOUSE WHEEL: step exactly one item per detent ──────────────
            let wheelDebounce = null;
            drum.addEventListener('wheel', e => {
                e.preventDefault();
                const dir = e.deltaY > 0 ? 1 : -1;
                const cur = getDrumValue(drum, maxVal);
                const next = Math.max(0, Math.min(maxVal - 1, cur + dir));
                drum.scrollTo({ top: next * ITEM_H, behavior: 'smooth' });
                highlightDrum(drum, maxVal);
                clearTimeout(wheelDebounce);
                wheelDebounce = setTimeout(() => highlightDrum(drum, maxVal), 120);
            }, { passive: false });

            // ── MOUSE DRAG ──────────────────────────────────────────────────
            let dragStart = null;   // { y, scrollTop }
            let dragging  = false;

            drum.addEventListener('mousedown', e => {
                e.preventDefault();
                dragStart = { y: e.clientY, scrollTop: drum.scrollTop };
                dragging  = true;
                drum.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', e => {
                if (!dragging || !dragStart) return;
                const delta = dragStart.y - e.clientY;
                drum.scrollTop = dragStart.scrollTop + delta;
                highlightDrum(drum, maxVal);
            });

            window.addEventListener('mouseup', () => {
                if (!dragging) return;
                dragging = false;
                drum.style.cursor = '';
                snapDrum(drum, maxVal);
                setTimeout(() => highlightDrum(drum, maxVal), 200);
            });

            // ── TOUCH: snap on end ──────────────────────────────────────────
            drum.addEventListener('touchend', () => {
                setTimeout(() => {
                    snapDrum(drum, maxVal);
                    setTimeout(() => highlightDrum(drum, maxVal), 200);
                }, 50);
            }, { passive: true });

            // ── SCROLL (fallback highlight) ─────────────────────────────────
            drum.addEventListener('scroll', () => highlightDrum(drum, maxVal), { passive: true });
        }

        function openTimePicker() {
            const now = new Date();
            const initH = pickerTime ? pickerTime.h : now.getHours();
            const initM = pickerTime ? pickerTime.m : now.getMinutes();
            const initS = pickerTime ? (pickerTime.s || 0) : 0;

            document.getElementById('time-overlay').style.display = 'flex';

            DRUMS.forEach(({ id, count }) => buildDrum(id, count));

            // Cloning resets all event listeners cleanly
            DRUMS.forEach(({ id, wrapId }) => {
                const oldDrum = document.getElementById(id);
                const newDrum = oldDrum.cloneNode(true);
                oldDrum.parentNode.replaceChild(newDrum, oldDrum);
            });

            setTimeout(() => {
                const dH = document.getElementById('drum-h');
                const dM = document.getElementById('drum-m');
                const dS = document.getElementById('drum-s');
                dH.scrollTop = initH * ITEM_H;
                dM.scrollTop = initM * ITEM_H;
                dS.scrollTop = initS * ITEM_H;
                highlightDrum(dH, 24);
                highlightDrum(dM, 60);
                highlightDrum(dS, 60);
                attachDrumControls(dH, 24);
                attachDrumControls(dM, 60);
                attachDrumControls(dS, 60);
            }, 80);
        }

        function closeTimePicker() { document.getElementById('time-overlay').style.display = 'none'; }

        function confirmTime() {
            const dH = document.getElementById('drum-h');
            const dM = document.getElementById('drum-m');
            const dS = document.getElementById('drum-s');
            pickerTime = {
                h: getDrumValue(dH, 24),
                m: getDrumValue(dM, 60),
                s: getDrumValue(dS, 60)
            };
            updateTimeDisplay();
            closeTimePicker();
        }

        // ===== ATTACH DROPDOWN =====
        let attachDropdownOpen = false;

        function buildAttachDropdown() {
            const dd = document.getElementById('attach-dropdown');
            const items = [...(appData.notes||[]), ...(appData.todos||[])];
            dd.innerHTML = '';

            if (items.length === 0) {
                dd.innerHTML = '<div class="dropdown-item" style="opacity:0.5;cursor:default;">Нет заметок или задач</div>';
                return;
            }

            // Header hint
            const hint = document.createElement('div');
            hint.style.cssText = 'padding:8px 16px 4px;font-size:10px;letter-spacing:1.5px;color:var(--hint);text-transform:uppercase;';
            hint.textContent = 'Выберите один или несколько';
            dd.appendChild(hint);

            items.forEach(item => {
                const badge = item.type === 'note' ? 'Заметка' : 'Задача';
                const isSelected = pickerAttach.includes(item.title);
                const el = document.createElement('div');
                el.className = 'dropdown-item' + (isSelected ? ' selected' : '');
                el.innerHTML = `
                    <div style="width:18px;height:18px;border-radius:5px;border:1px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};background:${isSelected ? 'var(--accent)' : 'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:0.15s;">
                        ${isSelected ? '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </div>
                    <span class="item-badge">${badge}</span>
                    <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.title}</span>
                `;
                el.onclick = () => toggleAttachItem(item.title);
                dd.appendChild(el);
            });

            // Clear all button
            if (pickerAttach.length > 0) {
                const clearBtn = document.createElement('div');
                clearBtn.className = 'dropdown-item';
                clearBtn.style.cssText = 'color:var(--danger);border-top:1px solid var(--border);margin-top:4px;';
                clearBtn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Очистить всё`;
                clearBtn.onclick = () => { pickerAttach = []; buildAttachDropdown(); updateAttachDisplay(); };
                dd.appendChild(clearBtn);
            }
        }

        function toggleAttachItem(title) {
            const idx = pickerAttach.indexOf(title);
            if (idx === -1) pickerAttach.push(title);
            else pickerAttach.splice(idx, 1);
            buildAttachDropdown();
            updateAttachDisplay();
        }

        function updateAttachDisplay() {
            const txt = document.getElementById('attach-display-text');
            const el  = document.getElementById('attach-display');
            if (pickerAttach.length === 0) {
                txt.textContent = '— Без привязки —';
                el.classList.remove('filled');
            } else if (pickerAttach.length === 1) {
                txt.textContent = pickerAttach[0];
                el.classList.add('filled');
            } else {
                txt.textContent = `${pickerAttach.length} прикреплено`;
                el.classList.add('filled');
            }
        }

        function toggleAttachDropdown() {
            const dd = document.getElementById('attach-dropdown');
            attachDropdownOpen = !attachDropdownOpen;
            if (attachDropdownOpen) {
                buildAttachDropdown();
                dd.style.display = 'block';
            } else {
                dd.style.display = 'none';
            }
        }

        // ===== EDITOR =====
        function openEditor(id = null) {
            editingId = id;
            const modal = document.getElementById('editor-modal');
            const titleEl = document.getElementById('edit-title');
            const descEl = document.getElementById('edit-desc');
            const remOpts = document.getElementById('reminder-options');
            const descBlock = document.getElementById('desc-block');
            const btnDel = document.getElementById('btn-delete');
            const modalTitle = document.getElementById('modal-title');

            // Reset picker state
            pickerDate = null; pickerTime = null; pickerAttach = [];
            attachDropdownOpen = false;
            document.getElementById('attach-dropdown').style.display = 'none';

            if (currentTab === 'reminders') {
                remOpts.style.display = 'block';
                descBlock.style.display = 'none';
                modalTitle.textContent = id !== null ? 'РЕДАКТИРОВАТЬ ТАЙМЕР' : 'НОВЫЙ ТАЙМЕР';
            } else {
                remOpts.style.display = 'none';
                descBlock.style.display = 'block';
                modalTitle.textContent = id !== null
                    ? (currentTab === 'notes' ? 'РЕДАКТИРОВАТЬ ЗАМЕТКУ' : 'РЕДАКТИРОВАТЬ ЗАДАЧУ')
                    : (currentTab === 'notes' ? 'НОВАЯ ЗАМЕТКА' : 'НОВАЯ ЗАДАЧА');
            }

            if (id !== null) {
                const item = appData[currentTab].find(i => i.id === id);
                if (!item) return;
                titleEl.value = item.title || '';
                if (currentTab === 'reminders') {
                    if (item.time_str) {
                        const dt = new Date(item.time_str);
                        pickerDate = { year: dt.getFullYear(), month: dt.getMonth(), day: dt.getDate() };
                        pickerTime = { h: dt.getHours(), m: dt.getMinutes(), s: dt.getSeconds() };
                    }
                    const rawAttach = item.attached;
                    pickerAttach = Array.isArray(rawAttach) ? rawAttach : (rawAttach && rawAttach !== '' ? [rawAttach] : []);
                    updateAttachDisplay();
                } else {
                    descEl.value = item.desc || '';
                }
                btnDel.style.display = 'flex'; btnDel.style.alignItems = 'center'; btnDel.style.justifyContent = 'center';
            } else {
                titleEl.value = ''; descEl.value = '';
                btnDel.style.display = 'none';
            }

            updateDateDisplay();
            updateTimeDisplay();

            modal.classList.add('open');
            setTimeout(() => titleEl.focus(), 400);
        }

        function closeEditor() {
            document.getElementById('editor-modal').classList.remove('open');
        }

        // ===== SAVE =====
        function saveItem() {
            const title = document.getElementById('edit-title').value.trim();
            if (!title) { tg.showAlert("Введите название!"); return; }

            const newItem = {
                id: editingId !== null ? editingId : Date.now(),
                type: currentTab === 'todos' ? 'todo' : currentTab === 'reminders' ? 'reminder' : 'note',
                title: title,
                date: new Date().toLocaleDateString('ru-RU')
            };

            if (currentTab === 'reminders') {
                if (!pickerDate) { tg.showAlert("Выберите дату!"); return; }
                if (!pickerTime) { tg.showAlert("Выберите время!"); return; }
                const timeStr = getPickerDateTimeString();
                newItem.time_str = timeStr;
                newItem.timestamp = Math.floor(new Date(timeStr).getTime() / 1000);
                newItem.attached = pickerAttach.slice(); // store as array
            } else {
                newItem.desc = document.getElementById('edit-desc').value.trim();
            }

            if (editingId !== null) {
                const idx = appData[currentTab].findIndex(i => i.id === editingId);
                if (idx !== -1) appData[currentTab][idx] = newItem;
            } else {
                appData[currentTab].push(newItem);
            }

            saveDataToCloud();
            closeEditor();
            renderList();

            // Send to Lua bot
            const luaPayload = {
                action: 'save_' + newItem.type,
                title: newItem.title,
                name: newItem.title,
                desc: newItem.desc || "",
                text: newItem.desc || "",
                timestamp: newItem.timestamp || 0,
                attached: Array.isArray(newItem.attached) ? newItem.attached.join(', ') : (newItem.attached || "")
            };

            try {
                if (tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0) {
                    tg.sendData(JSON.stringify(luaPayload));
                }
            } catch(e) {}
        }

        // ===== VIEW (FULLSCREEN) =====
        let viewingId = null;
        let viewingTab = null;

        function openView(id) {
            viewingId = id;
            viewingTab = currentTab;
            const item = appData[currentTab].find(i => i.id === id);
            if (!item) return;

            const modal = document.getElementById('view-modal');
            const body  = document.getElementById('view-body');
            const topTitle = document.getElementById('view-topbar-title');

            const typeLabels = { note: 'ЗАМЕТКА', todo: 'ЗАДАЧА', reminder: 'ТАЙМЕР' };
            topTitle.textContent = typeLabels[item.type] || 'ПРОСМОТР';

            let html = `<div class="view-title">${item.title}</div>`;

            // meta badges
            html += `<div class="view-meta-row">`;
            html += `<span class="view-badge">${item.date || ''}</span>`;
            if (item.type === 'note')     html += `<span class="view-badge accent">Заметка</span>`;
            if (item.type === 'todo')     html += `<span class="view-badge accent">Задача</span>`;
            if (item.type === 'reminder') html += `<span class="view-badge accent">Напоминание</span>`;
            html += `</div>`;

            if (item.type === 'reminder') {
                // Timer block
                const dtStr = item.time_str ? item.time_str.replace('T', ' ') : '—';
                html += `
                    <div class="view-timer-block">
                        <div class="view-timer-label">Сработает</div>
                        <div class="view-timer-time">${dtStr}</div>
                        <div class="view-countdown-big" id="view-cd">Считаем...</div>
                    </div>
                `;

                // Attached items
                const attached = Array.isArray(item.attached) ? item.attached : (item.attached && item.attached !== '' ? [item.attached] : []);
                if (attached.length > 0) {
                    html += `<div class="view-section-label">Прикреплено (${attached.length})</div>`;
                    html += `<div class="view-attach-list">`;
                    attached.forEach(a => {
                        const found = [...(appData.notes||[]), ...(appData.todos||[])].find(x => x.title === a);
                        const badge = found ? (found.type === 'note' ? 'Заметка' : 'Задача') : '';
                        html += `
                            <div class="view-attach-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                <span>${a}</span>
                                ${badge ? `<span class="view-badge" style="margin-left:auto">${badge}</span>` : ''}
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
            } else {
                // Note / todo content
                html += `<div class="view-divider"></div>`;
                const text = item.desc || '';
                html += `<div class="view-content${text ? '' : ' empty'}">${text || 'Нет описания'}</div>`;
            }

            body.innerHTML = html;
            modal.classList.add('open');

            // Live countdown for reminders
            if (item.type === 'reminder' && item.timestamp) {
                updateViewCountdown(item.timestamp);
                window._viewCdInterval = setInterval(() => updateViewCountdown(item.timestamp), 1000);
            }
        }

        function updateViewCountdown(ts) {
            const el = document.getElementById('view-cd');
            if (!el) { clearInterval(window._viewCdInterval); return; }
            const diff = ts - Math.floor(Date.now()/1000);
            if (diff <= 0) { el.textContent = '⚡ Время вышло!'; clearInterval(window._viewCdInterval); return; }
            const d = Math.floor(diff/86400);
            const h = Math.floor((diff%86400)/3600);
            const m = Math.floor((diff%3600)/60);
            const s = diff%60;
            el.textContent = d > 0 ? `Осталось: ${d}д ${h}ч ${m}м ${s}с` : `Осталось: ${h}ч ${m}м ${s}с`;
        }

        function closeView() {
            clearInterval(window._viewCdInterval);
            document.getElementById('view-modal').classList.remove('open');
            viewingId = null;
        }

        function editFromView() {
            const id = viewingId;
            closeView();
            openEditor(id);
        }

        // ===== DELETE =====
        function deleteItem() {
            tg.showConfirm("Удалить запись?", (confirmed) => {
                if (confirmed) {
                    appData[currentTab] = appData[currentTab].filter(i => i.id !== editingId);
                    saveDataToCloud();
                    closeEditor();
                    renderList();
                }
            });
        }

        // ===== RENDER =====
        function renderList() {
            if (currentTab === 'settings') return;
            const container = document.getElementById(currentTab + '-list');
            if (!container) return;
            const items = appData[currentTab];

            if (!items || items.length === 0) {
                const icons = {
                    notes: `<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`,
                    todos: `<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>`,
                    reminders: `<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`
                };
                const labels = { notes: 'Нет заметок', todos: 'Нет задач', reminders: 'Нет таймеров' };
                container.innerHTML = `<div class="empty-state">${icons[currentTab]}<p>${labels[currentTab]}</p></div>`;
                return;
            }

            const EDIT_ICON = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;

            container.innerHTML = '';
            items.slice().reverse().forEach(item => {
                let preview = '';
                if (currentTab === 'reminders') {
                    const dtStr = item.time_str ? item.time_str.replace('T', ' ').slice(0, 16) : '';
                    // Show attached count badge
                    const attached = Array.isArray(item.attached) ? item.attached : (item.attached ? [item.attached] : []);
                    const attachBadge = attached.length > 0
                        ? `<span class="attach-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>${attached.length} прикр.</span>` : '';
                    preview = `<div class="card-meta"><span>${dtStr}</span><span class="countdown" id="cd-${item.id}">...</span></div>${attachBadge}`;
                } else {
                    const descPreview = (item.desc || '').slice(0, 120) + ((item.desc || '').length > 120 ? '…' : '');
                    preview = `
                        <div class="card-text">${descPreview}</div>
                        <div class="card-meta"><span>Изменено: ${item.date}</span></div>
                    `;
                }

                container.innerHTML += `
                    <div class="card" style="cursor:default;">
                        <div class="card-accent-line"></div>
                        <div class="card-inner" style="display:flex;flex-direction:column;flex:1;">
                            <div style="display:flex;align-items:flex-start;gap:8px;">
                                <div style="flex:1;min-width:0;" onclick="openView(${item.id})" style="cursor:pointer;">
                                    <div class="card-title">${item.title}</div>
                                    ${preview}
                                </div>
                                <button onclick="event.stopPropagation();openEditor(${item.id})" style="background:var(--surface2);border:1px solid var(--border);color:var(--hint);border-radius:10px;padding:7px 9px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:2px;transition:0.15s;" onmouseenter="this.style.color='var(--accent)';this.style.borderColor='var(--accent)'" onmouseleave="this.style.color='var(--hint)';this.style.borderColor='var(--border)'">${EDIT_ICON}</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Make card body clickable for view
            container.querySelectorAll('.card').forEach(card => {
                const inner = card.querySelector('.card-inner > div > div:first-child');
                if (inner) inner.style.cursor = 'pointer';
            });
        }

        // ===== COUNTDOWN TIMERS =====
        setInterval(() => {
            if (currentTab !== 'reminders') return;
            const now = Math.floor(Date.now() / 1000);
            (appData.reminders || []).forEach(item => {
                const el = document.getElementById('cd-' + item.id);
                if (!el) return;
                const diff = (item.timestamp || 0) - now;
                if (diff <= 0) { el.innerText = '⚡ Время!'; return; }
                const d = Math.floor(diff / 86400);
                const h = Math.floor((diff % 86400) / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                el.innerText = d > 0 ? `${d}д ${h}ч ${m}м` : `${h}ч ${m}м ${s}с`;
            });
        }, 1000);

        // ===== STARFIELD — REALISTIC METEOR SHOWER =====
        let starAnimId;

        function getAccentColor() {
            return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#00d4ff';
        }

        function hexToRgb(hex) {
            hex = hex.replace('#','');
            if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
            const n = parseInt(hex, 16);
            return [(n >> 16) & 255, (n >> 8) & 255, n & 255];
        }

        function initStars() {
            cancelAnimationFrame(starAnimId);
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const W = canvas.width, H = canvas.height;

            // --- Static background stars with random twinkling ---
            const bgStars = [];
            for (let i = 0; i < 220; i++) {
                bgStars.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    r: Math.random() * 1.2 + 0.2,
                    alpha: Math.random() * 0.6 + 0.15,
                    pulse: Math.random() * Math.PI * 2,
                    pulseSpeed: Math.random() * 0.02 + 0.005,
                    hue: Math.random() < 0.3 ? [180,220,255] : [255,255,255],
                    // Twinkling: each star has a random chance to flash brightly
                    twinklePhase: Math.random() * Math.PI * 2,
                    twinkleSpeed: Math.random() * 0.008 + 0.001,  // very slow base
                    twinkleChance: Math.random(), // 0..1, only ~20% stars twinkle fast
                    flashTimer: Math.random() * 600,  // frame countdown to next flash
                    flashing: false,
                    flashBrightness: 0
                });
            }

            // --- Radiant point (top-left area, like in photo) ---
            const radiantX = W * 0.15;
            const radiantY = H * 0.10;

            // --- Meteors ---
            // All meteors diverge FROM the radiant point outward (parallel-ish, like Leonids)
            function createMeteor(immediate = false) {
                // Spread angle: mostly going down-right, some variation
                const baseAngle = Math.PI * 0.30; // ~54° from horizontal
                const spread = (Math.random() - 0.5) * 0.22;
                const angle = baseAngle + spread;

                // Travel distance across screen
                const dist = (Math.random() * 0.5 + 0.6) * Math.sqrt(W*W + H*H);

                // Start near radiant with offset so they look parallel
                const offset = (Math.random() - 0.5) * W * 1.2;
                const perpX = Math.cos(angle + Math.PI/2);
                const perpY = Math.sin(angle + Math.PI/2);

                const sx = radiantX + perpX * offset;
                const sy = radiantY + perpY * offset;
                const ex = sx + Math.cos(angle) * dist;
                const ey = sy + Math.sin(angle) * dist;

                const speed = Math.random() * 2.5 + 1.8; // px per frame
                const length = Math.random() * 180 + 80; // tail length px
                const width = Math.random() * 1.2 + 0.5;
                const brightness = Math.random() * 0.5 + 0.5;

                // Green-yellow core like real meteors, with accent tint
                const useGreen = Math.random() < 0.6;

                return {
                    sx, sy, ex, ey,
                    angle,
                    dx: Math.cos(angle),
                    dy: Math.sin(angle),
                    // current head position
                    hx: sx, hy: sy,
                    speed,
                    length,
                    width,
                    brightness,
                    useGreen,
                    // total travel
                    totalDist: dist,
                    traveled: immediate ? Math.random() * dist : 0,
                    // fade in/out
                    alive: true
                };
            }

            const meteors = [];
            // Start with some already mid-flight
            for (let i = 0; i < 7; i++) meteors.push(createMeteor(true));

            // Spawn new ones over time
            let spawnTimer = 0;

            function drawBgStar(s) {
                s.pulse += s.pulseSpeed;
                let a = s.alpha * (0.7 + 0.3 * Math.sin(s.pulse));

                // Random flash twinkle
                s.flashTimer--;
                if (s.flashTimer <= 0 && !s.flashing) {
                    // Only 25% of stars ever flash
                    if (s.twinkleChance < 0.25) {
                        s.flashing = true;
                        s.flashBrightness = 0;
                    }
                    // Reset timer: random 3-15 seconds (at ~60fps)
                    s.flashTimer = 180 + Math.random() * 720;
                }
                if (s.flashing) {
                    s.flashBrightness += 0.08;
                    if (s.flashBrightness >= Math.PI) {
                        s.flashing = false;
                        s.flashBrightness = 0;
                    } else {
                        // Flash arc: sin curve 0→1→0
                        const boost = Math.sin(s.flashBrightness);
                        a = Math.min(1, a + boost * 0.85);
                    }
                }

                const [r,g,b] = s.hue;

                // Sparkle cross for bright or flashing stars
                const isBright = s.r > 0.9 || (s.flashing && s.flashBrightness > 0.3);
                if (isBright) {
                    const boost = s.flashing ? Math.sin(s.flashBrightness) : 0;
                    const arm = s.r * (3 + boost * 6);
                    ctx.save();
                    ctx.globalAlpha = a * (0.3 + boost * 0.5);
                    // Accent-colored glow on flash
                    const flashRgb = hexToRgb(getAccentColor());
                    const cr = s.flashing ? flashRgb[0] : r;
                    const cg = s.flashing ? flashRgb[1] : g;
                    const cb = s.flashing ? flashRgb[2] : b;
                    ctx.strokeStyle = `rgb(${cr},${cg},${cb})`;
                    ctx.lineWidth = 0.5 + boost;
                    ctx.beginPath(); ctx.moveTo(s.x-arm,s.y); ctx.lineTo(s.x+arm,s.y); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(s.x,s.y-arm); ctx.lineTo(s.x,s.y+arm); ctx.stroke();
                    // Diagonal arms on strong flash
                    if (boost > 0.5) {
                        const d = arm * 0.6;
                        ctx.globalAlpha *= 0.5;
                        ctx.beginPath(); ctx.moveTo(s.x-d,s.y-d); ctx.lineTo(s.x+d,s.y+d); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(s.x+d,s.y-d); ctx.lineTo(s.x-d,s.y+d); ctx.stroke();
                    }
                    ctx.restore();
                }

                // Glow halo on flash
                if (s.flashing && s.flashBrightness > 0.2) {
                    const boost = Math.sin(s.flashBrightness);
                    const flashRgb = hexToRgb(getAccentColor());
                    const haloGrad = ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*10*boost);
                    haloGrad.addColorStop(0, `rgba(${flashRgb[0]},${flashRgb[1]},${flashRgb[2]},${boost*0.4})`);
                    haloGrad.addColorStop(1, `rgba(${flashRgb[0]},${flashRgb[1]},${flashRgb[2]},0)`);
                    ctx.beginPath(); ctx.arc(s.x,s.y,s.r*10*boost,0,Math.PI*2);
                    ctx.fillStyle = haloGrad; ctx.fill();
                }

                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r * (1 + (s.flashing ? Math.sin(s.flashBrightness)*0.8 : 0)), 0, Math.PI*2);
                ctx.fillStyle = `rgba(${r},${g},${b},${a})`;
                ctx.fill();
            }

            function drawMeteor(m) {
                m.traveled += m.speed;
                m.hx = m.sx + m.dx * m.traveled;
                m.hy = m.sy + m.dy * m.traveled;

                // Check if off screen enough
                if (m.traveled > m.totalDist + m.length) {
                    m.alive = false;
                    return;
                }

                // Tail start (behind head)
                const tailLen = Math.min(m.length, m.traveled);
                const tx = m.hx - m.dx * tailLen;
                const ty = m.hy - m.dy * tailLen;

                // Fade based on position (fade in at start, fade out near end)
                const progress = m.traveled / m.totalDist;
                let masterAlpha = m.brightness;
                if (progress < 0.08) masterAlpha *= progress / 0.08;
                if (progress > 0.75) masterAlpha *= Math.max(0, 1 - (progress - 0.75) / 0.25);

                const accent = getAccentColor();
                const accentRgb = hexToRgb(accent);

                // === OUTER WIDE GLOW (diffuse) ===
                const outerGrad = ctx.createLinearGradient(tx, ty, m.hx, m.hy);
                outerGrad.addColorStop(0, `rgba(${accentRgb[0]},${accentRgb[1]},${accentRgb[2]},0)`);
                outerGrad.addColorStop(0.6, `rgba(${accentRgb[0]},${accentRgb[1]},${accentRgb[2]},${masterAlpha * 0.12})`);
                outerGrad.addColorStop(1, `rgba(200,230,255,${masterAlpha * 0.15})`);

                ctx.save();
                ctx.lineWidth = m.width * 12;
                ctx.strokeStyle = outerGrad;
                ctx.lineCap = 'round';
                ctx.globalCompositeOperation = 'screen';
                ctx.beginPath(); ctx.moveTo(tx, ty); ctx.lineTo(m.hx, m.hy); ctx.stroke();

                // === MID GLOW (green-yellow like real meteors) ===
                const midGrad = ctx.createLinearGradient(tx, ty, m.hx, m.hy);
                midGrad.addColorStop(0, `rgba(0,0,0,0)`);
                if (m.useGreen) {
                    midGrad.addColorStop(0.5, `rgba(120,220,80,${masterAlpha * 0.35})`);
                    midGrad.addColorStop(0.85, `rgba(200,255,100,${masterAlpha * 0.55})`);
                    midGrad.addColorStop(1, `rgba(255,255,220,${masterAlpha * 0.8})`);
                } else {
                    midGrad.addColorStop(0.5, `rgba(${accentRgb[0]},${accentRgb[1]},${accentRgb[2]},${masterAlpha * 0.4})`);
                    midGrad.addColorStop(1, `rgba(255,255,255,${masterAlpha * 0.8})`);
                }
                ctx.lineWidth = m.width * 4;
                ctx.strokeStyle = midGrad;
                ctx.beginPath(); ctx.moveTo(tx, ty); ctx.lineTo(m.hx, m.hy); ctx.stroke();

                // === CORE (bright white center) ===
                const coreGrad = ctx.createLinearGradient(tx, ty, m.hx, m.hy);
                coreGrad.addColorStop(0, `rgba(255,255,255,0)`);
                coreGrad.addColorStop(0.7, `rgba(255,255,255,${masterAlpha * 0.6})`);
                coreGrad.addColorStop(1, `rgba(255,255,255,${masterAlpha})`);
                ctx.lineWidth = m.width * 0.8;
                ctx.strokeStyle = coreGrad;
                ctx.beginPath(); ctx.moveTo(tx, ty); ctx.lineTo(m.hx, m.hy); ctx.stroke();

                // === HEAD FLARE ===
                const hGrad = ctx.createRadialGradient(m.hx, m.hy, 0, m.hx, m.hy, m.width * 7);
                hGrad.addColorStop(0, `rgba(255,255,255,${masterAlpha * 0.95})`);
                hGrad.addColorStop(0.3, m.useGreen
                    ? `rgba(160,255,100,${masterAlpha * 0.5})`
                    : `rgba(${accentRgb[0]},${accentRgb[1]},${accentRgb[2]},${masterAlpha * 0.5})`);
                hGrad.addColorStop(1, `rgba(0,0,0,0)`);
                ctx.beginPath(); ctx.arc(m.hx, m.hy, m.width * 7, 0, Math.PI*2);
                ctx.fillStyle = hGrad; ctx.fill();

                ctx.restore();
            }

            function animate() {
                // Deep space background
                ctx.fillStyle = 'rgba(5, 8, 16, 0.18)';
                ctx.fillRect(0, 0, W, H);

                // Background stars
                ctx.globalCompositeOperation = 'source-over';
                bgStars.forEach(drawBgStar);

                // Subtle nebula in top-left corner like in photo
                const nebula = ctx.createRadialGradient(W*0.1, H*0.15, 0, W*0.1, H*0.15, W*0.35);
                nebula.addColorStop(0, 'rgba(80,30,60,0.04)');
                nebula.addColorStop(0.5, 'rgba(60,20,80,0.025)');
                nebula.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = nebula;
                ctx.fillRect(0, 0, W, H);

                // Meteors
                spawnTimer++;
                if (spawnTimer > 28 + Math.random() * 40 && meteors.length < 12) {
                    meteors.push(createMeteor(false));
                    spawnTimer = 0;
                }

                for (let i = meteors.length - 1; i >= 0; i--) {
                    drawMeteor(meteors[i]);
                    if (!meteors[i].alive) {
                        meteors.splice(i, 1);
                    }
                }

                starAnimId = requestAnimationFrame(animate);
            }

            // First frame: fill background solid
            ctx.fillStyle = '#050810';
            ctx.fillRect(0, 0, W, H);

            animate();
        }


        // ===== NEON FIELD (old-school neon stars from sides) =====
        function initNeonField() {
            cancelAnimationFrame(starAnimId);
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const W = canvas.width, H = canvas.height;

            function hexToRgbNf(hex) {
                hex = hex.replace('#','');
                if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
                const n = parseInt(hex, 16);
                return [(n>>16)&255, (n>>8)&255, n&255];
            }

            const particles = [];
            for (let i = 0; i < 120; i++) {
                const fromLeft = Math.random() < 0.5;
                particles.push({
                    x: fromLeft ? Math.random() * W * 0.2 : W - Math.random() * W * 0.2,
                    y: Math.random() * H,
                    size: Math.random() * 2 + 0.3,
                    speedX: (fromLeft ? 1 : -1) * (Math.random() * 0.4 + 0.1),
                    speedY: (Math.random() - 0.5) * 0.3,
                    opacity: Math.random() * 0.7 + 0.3,
                    pulse: Math.random() * Math.PI * 2,
                    fromLeft
                });
            }

            // Shooting stars
            const shoots = [];
            function mkShoot() {
                return {
                    x: Math.random() * W, y: -10,
                    len: Math.random() * 120 + 60,
                    speed: Math.random() * 3 + 2,
                    angle: Math.PI/2 + (Math.random()-0.5)*0.4,
                    alpha: Math.random() * 0.6 + 0.4,
                    done: false, progress: 0
                };
            }
            for (let i = 0; i < 4; i++) shoots.push(mkShoot());
            let shootTimer = 0;

            function animate() {
                ctx.fillStyle = 'rgba(5,8,16,0.15)';
                ctx.fillRect(0, 0, W, H);
                const accent = getAccentColor();
                const rgb = hexToRgbNf(accent);

                particles.forEach(s => {
                    s.pulse += 0.025;
                    const glow = 0.5 + 0.5 * Math.sin(s.pulse);
                    const a = s.opacity * glow;
                    const r = s.size * 6;
                    const grad = ctx.createRadialGradient(s.x,s.y,0, s.x,s.y,r);
                    grad.addColorStop(0, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${a})`);
                    grad.addColorStop(0.3, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${a*0.5})`);
                    grad.addColorStop(1, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},0)`);
                    ctx.beginPath(); ctx.arc(s.x, s.y, r, 0, Math.PI*2);
                    ctx.fillStyle = grad; ctx.fill();
                    ctx.beginPath(); ctx.arc(s.x, s.y, s.size*0.6, 0, Math.PI*2);
                    ctx.fillStyle = `rgba(255,255,255,${a*0.85})`; ctx.fill();

                    s.x += s.speedX; s.y += s.speedY;
                    if (s.x < -10 || s.x > W+10) {
                        s.fromLeft = !s.fromLeft;
                        s.x = s.fromLeft ? 0 : W;
                        s.y = Math.random() * H;
                        s.speedX = (s.fromLeft ? 1 : -1) * (Math.random()*0.4+0.1);
                    }
                    if (s.y < -5) s.y = H+5;
                    if (s.y > H+5) s.y = -5;
                });

                // Shooting stars
                shootTimer++;
                if (shootTimer > 90 && shoots.filter(s=>!s.done).length < 3) {
                    shoots.push(mkShoot()); shootTimer = 0;
                }
                for (let i = shoots.length-1; i >= 0; i--) {
                    const s = shoots[i];
                    s.progress += s.speed;
                    const hx = s.x + Math.cos(s.angle) * s.progress;
                    const hy = s.y + Math.sin(s.angle) * s.progress;
                    const tx = hx - Math.cos(s.angle) * s.len;
                    const ty = hy - Math.sin(s.angle) * s.len;
                    const g = ctx.createLinearGradient(tx,ty,hx,hy);
                    g.addColorStop(0, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},0)`);
                    g.addColorStop(0.7, `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${s.alpha*0.5})`);
                    g.addColorStop(1, `rgba(255,255,255,${s.alpha})`);
                    ctx.beginPath(); ctx.moveTo(tx,ty); ctx.lineTo(hx,hy);
                    ctx.strokeStyle = g; ctx.lineWidth = 1.5; ctx.stroke();
                    if (hy > H+s.len || hx > W+s.len || hx < -s.len) {
                        shoots.splice(i,1);
                    }
                }

                starAnimId = requestAnimationFrame(animate);
            }
            ctx.fillStyle = '#050810'; ctx.fillRect(0,0,W,H);
            animate();
        }

        window.addEventListener('resize', () => initBackground());

        // ===== BOOT =====
        loadData();
    </script>
</body>
</html>
